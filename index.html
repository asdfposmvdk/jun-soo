<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>진짜 손가락 지문 인증 (카메라만으로)</title>
  <script src="https://docs.opencv.org/4.x/opencv.js"></script>
  <style>
    body {font-family:sans-serif; background:#f0f0f0; text-align:center; padding:20px;}
    .container {max-width:500px; margin:0 auto; background:white; border-radius:20px; padding:20px; box-shadow:0 10px 40px rgba(0,0,0,0.1);}
    video, canvas {width:100%; border-radius:16px; margin:10px 0;}
    button {padding:16px 32px; margin:10px; font-size:18px; border:none; border-radius:12px; color:white;}
    .reg {background:#ff6b6b;}
    .auth {background:#51cf66;}
    .clear {background:#868e96;}
    .status {margin:30px 0; font-size:20px; font-weight:bold;}
    .success {color:#51cf66;}
    .fail {color:#ff6b6b;}
    .guide {position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:200px; height:300px; border:4px dashed #00ff88; border-radius:20px; pointer-events:none;}
  </style>
</head>
<body>
  <div class="container">
    <h1>손가락 지문 인증</h1>
    <p>손가락을 카메라에 5~10cm 거리로 대세요</p>
    
    <div style="position:relative; display:inline-block;">
      <video id="video" autoplay playsinline muted></video>
      <div class="guide"></div>
      <canvas id="canvas" style="display:none;"></canvas>
    </div>

    <div class="status" id="status">준비 중...</div>
    
    <button class="reg" id="register">지문 등록</button>
    <button class="auth" id="verify" disabled>지문 인증</button>
    <button class="clear" id="clear">등록 삭제</button>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const status = document.getElementById('status');
    let registered = null;

    async function start() {
      const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}});
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        status.textContent = "손가락을 초록 테두리에 맞춰주세요";
        loop();
      };
    }

    function loop() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        ctx.drawImage(video, 0, 0);
        processFrame();
      }
      requestAnimationFrame(loop);
    }

    function processFrame() {
      const src = cv.imread(canvas);
      const gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

      // 지문 강화 + 이진화
      const enhanced = enhanceFingerprint(gray);
      const bin = new cv.Mat();
      cv.threshold(enhanced, bin, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);

      // minutiae 추출
      const points = extractMinutiae(bin);
      status.textContent = `지문 품질: ${points.length > 25 ? "최고" : "조금 더 가까이"} (특징점 ${points.length}개)`;

      if (points.length > 25) {
        document.getElementById('register').disabled = false;
        document.getElementById('verify').disabled = false;
        window.currentPoints = points;
      }

      cv.imshow(canvas, bin);
      src.delete(); gray.delete(); enhanced.delete(); bin.delete();
    }

    function enhanceFingerprint(mat) {
      const clahe = cv.createCLAHE(3.0, new cv.Size(8,8));
      const enhanced = new cv.Mat();
      clahe.apply(mat, enhanced);
      clahe.delete();
      return enhanced;
    }

    function extractMinutiae(bin) {
      const skeleton = new cv.Mat();
      cv.ximgproc.thinning(bin, skeleton);
      const points = [];
      const data = skeleton.data;
      const w = skeleton.cols, h = skeleton.rows;

      for (let y = 10; y < h-10; y++) {
        for (let x = 10; x < w-10; x++) {
          const i = y * w + x;
          if (data[i] === 255) {
            let cnt = 0;
            for (let dy = -1; dy <= 1; dy++)
              for (let dx = -1; dx <= 1; dx++)
                if (dx || dy) if (data[(y+dy)*w + (x+dx)] === 255) cnt++;
            if (cnt === 1 || cnt === 3) points.push({x, y, type: cnt===1 ? "end" : "bif"});
          }
        }
      }
      skeleton.delete();
      return points;
    }

    // 등록
    document.getElementById('register').onclick = () => {
      if (!window.currentPoints || window.currentPoints.length < 30) {
        status.textContent = "지문이 선명하지 않습니다";
        return;
      }
      localStorage.setItem('fingerprint', JSON.stringify(window.currentPoints));
      registered = window.currentPoints;
      status.innerHTML = `<span class="success">지문 등록 완료!</span><br>특징점 ${window.currentPoints.length}개 저장`;
    };

    // 인증
    document.getElementById('verify'). onclick = () => {
      if (!localStorage.getItem('fingerprint')) {
        status.textContent = "등록된 지문 없음";
        return;
      }
      const saved = JSON.parse(localStorage.getItem('fingerprint'));
      if (!window.currentPoints) return;

      let match = 0;
      for (const p1 of window.currentPoints) {
        for (const p2 of saved) {
          if (Math.hypot(p1.x - p2.x, p1.y - p2.y) < 25) {
            match++;
            break;
          }
        }
      }
      const score = match / Math.max(window.currentPoints.length, saved.length);

      if (score > 0.6) {
        status.innerHTML = `<span class="success">지문 인증 성공!</span><br>유사도 ${(score*100).toFixed(1)}%`;
      } else {
        status.innerHTML = `<span class="fail">인증 실패</span><br>유사도 ${(score*100).toFixed(1)}%`;
      }
    };

    document.getElementById('clear').onclick = () => {
      localStorage.removeItem('fingerprint');
      status.textContent = "등록된 지문 삭제됨";
      document.getElementById('verify').disabled = true;
    };

    // OpenCV 로드 완료 후 시작
    function onOpenCvReady() {
      start();
    }
    if (typeof cv !== 'undefined') onOpenCvReady();
    else cv['onRuntimeInitialized'] = onOpenCvReady;
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¤– AILee v3 - ì´¬ì˜ UX ê°€ì´ë“œ</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#f5f5f5;padding:10px;}
    .container{max-width:480px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:20px;}
    .header{text-align:center;margin-bottom:16px;border-bottom:2px solid #0070d2;padding-bottom:10px;}
    .header h1{font-size:20px;color:#0070d2;margin-bottom:4px;}
    .header p{font-size:12px;color:#666;}
    .message{padding:8px 10px;margin-bottom:8px;border-radius:6px;font-size:12px;display:none;}
    .message.show{display:block;}
    .message.info{background:#e7f3ff;border-left:4px solid #0070d2;color:#0070d2;}
    .message.error{background:#fef1f0;border-left:4px solid #c23030;color:#c23030;}
    .message.success{background:#dffcf0;border-left:4px solid #04844b;color:#04844b;}

    .video-container{position:relative;width:100%;max-width:480px;margin:0 auto 8px;background:#000;border-radius:10px;overflow:hidden;display:none;}
    video{width:100%;height:auto;display:block;object-fit:contain;background:#000;}
    .video-label{position:absolute;top:8px;left:8px;padding:4px 8px;border-radius:4px;background:rgba(0,0,0,0.6);color:#eee;font-size:11px;}
    .finger-guide{position:absolute;top:50%;left:50%;width:45%;height:45%;transform:translate(-50%,-50%);border-radius:12px;border:3px dashed rgba(255,255,255,0.9);pointer-events:none;transition:.15s;}
    .finger-guide.good{border-color:#00c853;background:rgba(0,200,83,0.08);}
    .finger-guide.warn{border-color:#ffb300;background:rgba(255,179,0,0.08);}
    .finger-guide.bad{border-color:#e53935;background:rgba(229,57,53,0.05);}
    .status-badge{position:absolute;bottom:8px;right:8px;padding:4px 8px;border-radius:999px;font-size:11px;color:#fff;background:rgba(0,0,0,0.7);}

    .button-group{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
    button{padding:10px 12px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;min-height:40px;}
    .btn-brand{background:#0070d2;color:#fff;}
    .btn-brand:hover{background:#005bb5;}
    .btn-cancel{background:#e0e0e0;color:#333;}
    .btn-cancel:hover{background:#d0d0d0;}
    .btn-disabled{background:#ccc !important;cursor:not-allowed !important;}

    #analyzeCanvas{display:none;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤– AILee v3</h1>
      <p>ê±°ë¦¬ Â· ìœ„ì¹˜ Â· ì¡°ëª…ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ í‰ê°€í•´ì£¼ëŠ” ì´¬ì˜ ê°€ì´ë“œ</p>
    </div>

    <div id="infoMessage" class="message info show">
      [ì‹œì‘]ì„ ëˆ„ë¥´ê³  ì†ê°€ë½ì„ ë„¤ëª¨ ì•ˆì— ë§ì¶°ë³´ì„¸ìš”. ì–´ë–¤ ì ì´ ì•ˆ ì¢‹ì€ì§€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì•Œë ¤ì¤˜ìš”.
    </div>
    <div id="errorMessage" class="message error"></div>
    <div id="successMessage" class="message success"></div>

    <div id="videoContainer" class="video-container">
      <video id="video" autoplay playsinline muted></video>
      <div class="video-label">ğŸ“· ì´¬ì˜ ê°€ì´ë“œ ëª¨ë“œ</div>
      <div id="fingerGuide" class="finger-guide"></div>
      <div id="statusBadge" class="status-badge">ëŒ€ê¸° ì¤‘</div>
    </div>

    <canvas id="analyzeCanvas" width="160" height="120"></canvas>

    <div class="button-group">
      <button id="startBtn" class="btn-brand" onclick="startCamera()">ğŸ“· ì‹œì‘</button>
      <button id="stopBtn" class="btn-cancel btn-disabled" onclick="stopCamera()" disabled>âŒ ì¢…ë£Œ</button>
    </div>
  </div>

  <script>
    let stream=null,video=null,analyzeCanvas=null,analyzeCtx=null,analyzing=false;
    const infoMessage=document.getElementById("infoMessage");
    const errorMessage=document.getElementById("errorMessage");
    const successMessage=document.getElementById("successMessage");
    const videoContainer=document.getElementById("videoContainer");
    const fingerGuide=document.getElementById("fingerGuide");
    const statusBadge=document.getElementById("statusBadge");
    const startBtn=document.getElementById("startBtn");
    const stopBtn=document.getElementById("stopBtn");

    function setInfo(m){infoMessage.textContent=m;infoMessage.classList.add("show");}
    function clearInfo(){infoMessage.classList.remove("show");}
    function setError(m){errorMessage.textContent=m;errorMessage.classList.add("show");}
    function clearError(){errorMessage.classList.remove("show");}
    function setSuccess(m){successMessage.textContent=m;successMessage.classList.add("show");}
    function clearSuccess(){successMessage.classList.remove("show");}

    function setButtons(running){
      if(running){
        startBtn.disabled=true;startBtn.classList.add("btn-disabled");
        stopBtn.disabled=false;stopBtn.classList.remove("btn-disabled");
      }else{
        startBtn.disabled=false;startBtn.classList.remove("btn-disabled");
        stopBtn.disabled=true;stopBtn.classList.add("btn-disabled");
      }
    }

    async function startCamera(){
      try{
        clearError();clearSuccess();
        setInfo("ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...");
        const constraints={
          video:{facingMode:{ideal:"environment"},width:{ideal:1920},height:{ideal:1080}},
          audio:false
        };
        stream=await navigator.mediaDevices.getUserMedia(constraints);
        video=document.getElementById("video");
        analyzeCanvas=document.getElementById("analyzeCanvas");
        analyzeCtx=analyzeCanvas.getContext("2d");
        video.srcObject=stream;
        await video.play();
        videoContainer.style.display="block";
        analyzing=true;
        setButtons(true);
        setInfo("ì†ê°€ë½ì„ ë„¤ëª¨ ì•ˆì— ë§ì¶”ê³ , ì•„ë˜ ë©”ì‹œì§€ ë³´ê³  ê±°ë¦¬/ìœ„ì¹˜/ì¡°ëª…ì„ ì¡°ì •í•´ë³´ì„¸ìš”.");
        requestAnimationFrame(analyzeLoop);
      }catch(e){
        setError("ì¹´ë©”ë¼ ì‚¬ìš© ë¶ˆê°€: "+e.message);
        setButtons(false);
      }
    }

    function stopCamera(){
      analyzing=false;
      if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
      if(video){video.srcObject=null;}
      videoContainer.style.display="none";
      fingerGuide.className="finger-guide";
      statusBadge.textContent="ëŒ€ê¸° ì¤‘";
      setButtons(false);
      setInfo("ì¹´ë©”ë¼ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      clearError();clearSuccess();
    }

    function isSkinPixel(r,g,b){
      const max=Math.max(r,g,b),min=Math.min(r,g,b),diff=max-min;
      return (r>80&&g>40&&b>20&&r>=g&&r>=b&&diff>15&&!(r>230&&g>230&&b>230));
    }

    function analyzeLoop(){
      if(!analyzing||!video||video.readyState<2){
        if(analyzing)requestAnimationFrame(analyzeLoop);
        return;
      }
      const w=analyzeCanvas.width,h=analyzeCanvas.height;
      analyzeCtx.drawImage(video,0,0,w,h);
      const frame=analyzeCtx.getImageData(0,0,w,h),data=frame.data;

      const roiX=Math.floor(w*0.275),roiY=Math.floor(h*0.275),
            roiW=Math.floor(w*0.45),roiH=Math.floor(h*0.45);

      let skinCount=0,totalCount=0,minX=roiW,maxX=0,minY=roiH,maxY=0;
      let brightSum=0; // ë°ê¸° í‰ê· ìš©

      for(let y=roiY;y<roiY+roiH;y++){
        for(let x=roiX;x<roiX+roiW;x++){
          const idx=(y*w+x)*4;
          const r=data[idx],g=data[idx+1],b=data[idx+2];
          totalCount++;
          const gray=0.299*r+0.587*g+0.114*b;
          brightSum+=gray;
          if(isSkinPixel(r,g,b)){
            skinCount++;
            const lx=x-roiX,ly=y-roiY;
            if(lx<minX)minX=lx;if(lx>maxX)maxX=lx;
            if(ly<minY)minY=ly;if(ly>maxY)maxY=ly;
          }
        }
      }

      const brightness=brightSum/totalCount; // 0~255
      const skinRatio=skinCount/totalCount;
      let status="bad",msg="",badge="ë‚˜ì¨";

      // 1) ì¡°ëª… ì²´í¬ ë¨¼ì €
      if(brightness<70){
        status="bad";
        msg="í™”ë©´ì´ ë„ˆë¬´ ì–´ë‘¡ìŠµë‹ˆë‹¤. ë°© ì¡°ëª…ì„ ì¼œê±°ë‚˜ ì°½ê°€ ìª½ìœ¼ë¡œ ì´ë™í•´ ì£¼ì„¸ìš”.";
      }else if(brightness>200){
        status="bad";
        msg="ë„ˆë¬´ ë°ê±°ë‚˜ ë¹›ì´ ê°•í•˜ê²Œ ë°˜ì‚¬ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì§ì‚¬ê´‘ì„ ì„ í”¼í•˜ê³  ì†ê°€ë½ì— ë¹„ì¹˜ëŠ” ê°•í•œ ë¹›ì„ ì¤„ì—¬ì£¼ì„¸ìš”.";
      }else if(skinRatio<0.05){
        status="bad";
        msg="ì†ê°€ë½ì´ ì˜ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë„¤ëª¨ ì•ˆìœ¼ë¡œ ì†ê°€ë½ì„ ê°€ì ¸ì˜¤ê³ , ì¹´ë©”ë¼ì™€ì˜ ê±°ë¦¬ë¥¼ ì¡°ê¸ˆ ë” ê°€ê¹ê²Œ ë§ì¶°ì£¼ì„¸ìš”.";
      }else{
        // 2) ê±°ë¦¬/ìœ„ì¹˜ í‰ê°€
        const width=maxX-minX,height=maxY-minY,area=width*height,roiArea=roiW*roiH;
        const areaRatio=area/roiArea;
        const cx=(minX+maxX)/2,cy=(minY+maxY)/2;
        const nx=cx/roiW,ny=cy/roiH;
        const centerOffX=Math.abs(nx-0.5),centerOffY=Math.abs(ny-0.5);

        if(centerOffX>0.25||centerOffY>0.25){
          status="warn";
          msg="ì†ê°€ë½ ìœ„ì¹˜ê°€ ê°€ìš´ë°ì—ì„œ ë§ì´ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ë„¤ëª¨ ì¤‘ì•™ì— ì†ê°€ë½ ëì´ ì˜¤ë„ë¡ ë§ì¶°ì£¼ì„¸ìš”.";
        }else if(areaRatio<0.12){
          status="warn";
          msg="ì†ê°€ë½ì´ ë„ˆë¬´ ë©‰ë‹ˆë‹¤. ì¹´ë©”ë¼ ìª½ìœ¼ë¡œ ì¡°ê¸ˆ ë” ê°€ê¹Œì´ ê°€ì ¸ì™€ ì£¼ì„¸ìš”(ë„ˆë¬´ ê°€ê¹ê²ŒëŠ” X).";
        }else if(areaRatio>0.55){
          status="warn";
          msg="ì†ê°€ë½ì´ ë„ˆë¬´ ê°€ê¹ìŠµë‹ˆë‹¤. í™”ë©´ì—ì„œ ì†ê°€ë½ì´ ë„ˆë¬´ í¬ê²Œ ë³´ì´ë©´ 1~2cm ì •ë„ ë’¤ë¡œ ë¹¼ì£¼ì„¸ìš”.";
        }else{
          status="good";
          msg="ì§€ë¬¸ì„ ì´¬ì˜í•˜ê¸°ì— ì¢‹ì€ ê±°ë¦¬/ìœ„ì¹˜/ì¡°ëª…ì…ë‹ˆë‹¤. ì´ ìƒíƒœì—ì„œ ìº¡ì²˜/ë“±ë¡ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.";
        }
      }

      // UI ë°˜ì˜
      fingerGuide.className="finger-guide " + (status==="good"?"good":status==="warn"?"warn":"bad");
      statusBadge.textContent=
        status==="good" ? "ì–‘í˜¸" :
        status==="warn" ? "ì¡°ì • í•„ìš”" : "ë‚˜ì¨";

      if(status==="good"){
        setSuccess(msg);clearError();
      }else if(status==="warn"){
        clearSuccess();setError(msg);
      }else{
        clearSuccess();setError(msg);
      }

      if(analyzing)requestAnimationFrame(analyzeLoop);
    }

    window.addEventListener("unload",()=>{if(stream)stream.getTracks().forEach(t=>t.stop());});
  </script>
</body>
</html>

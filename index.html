<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AILee v2 Pro - 카메라 기반 손가락 인증</title>

  <!--
    AILee v2 Pro - Touchless Finger Pattern Recognition Demo
    MIT License (c) 2025 깽호
  -->

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#f5f5f5;padding:10px;}
    .container{max-width:480px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:20px;}
    .header{text-align:center;margin-bottom:16px;border-bottom:2px solid #0070d2;padding-bottom:10px;}
    .header h1{font-size:20px;color:#0070d2;margin-bottom:4px;}
    .header p{font-size:12px;color:#666;}

    .message{padding:8px 10px;margin-bottom:8px;border-radius:6px;font-size:12px;display:none;word-break:break-word;}
    .message.show{display:block;}
    .message.info{background:#e7f3ff;border-left:4px solid #0070d2;color:#0070d2;}
    .message.error{background:#fef1f0;border-left:4px solid #c23030;color:#c23030;}
    .message.success{background:#dffcf0;border-left:4px solid #04844b;color:#04844b;}

    .video-container{position:relative;width:100%;max-width:480px;margin:0 auto 8px;background:#000;border-radius:10px;overflow:hidden;display:none;}
    video{width:100%;height:auto;display:block;object-fit:cover;background:#000;}
    .video-label{position:absolute;top:8px;left:8px;padding:4px 8px;border-radius:4px;background:rgba(0,0,0,0.6);color:#eee;font-size:11px;pointer-events:none;}

    .finger-guide{
      position:absolute;top:50%;left:50%;
      width:45%;height:45%;transform:translate(-50%,-50%);
      border-radius:12px;border:3px dashed rgba(255,255,255,0.9);
      pointer-events:none;transition:.15s;
    }
    .finger-guide.state-idle{border-color:rgba(255,255,255,0.9);}
    .finger-guide.state-good{border-color:#00c853;box-shadow:0 0 0 2px rgba(0,200,83,0.4);background:rgba(0,200,83,0.06);}
    .finger-guide.state-warn{border-color:#ffb300;box-shadow:0 0 0 2px rgba(255,179,0,0.4);background:rgba(255,179,0,0.08);}
    .finger-guide.state-bad{border-color:#e53935;box-shadow:0 0 0 2px rgba(229,57,53,0.4);background:rgba(229,57,53,0.05);}

    .status-badge{
      position:absolute;bottom:8px;right:8px;
      padding:4px 8px;border-radius:999px;font-size:11px;color:#fff;
      background:rgba(0,0,0,0.6);pointer-events:none;
    }
    .status-badge.good{background:rgba(0,200,83,0.95);}
    .status-badge.warn{background:rgba(255,179,0,0.95);}
    .status-badge.bad{background:rgba(229,57,53,0.95);}

    .button-group{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
    button{
      padding:10px 12px;border:none;border-radius:6px;font-size:13px;font-weight:600;
      cursor:pointer;min-height:40px;transition:.15s;
    }
    button:active{transform:scale(.97);}
    .btn-brand{background:#0070d2;color:#fff;}
    .btn-brand:hover{background:#005bb5;}
    .btn-cancel{background:#e0e0e0;color:#333;}
    .btn-disabled{background:#ccc !important;cursor:not-allowed !important;}

    #analyzeCanvas{display:none;}

    .auth-result{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      padding:16px 22px;border-radius:999px;background:rgba(0,200,83,0.92);
      color:white;font-size:17px;font-weight:bold;display:none;
      box-shadow:0 4px 18px rgba(0,0,0,0.4);z-index:10;
    }
    .auth-result.show{display:block;}
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <h1>AILee v2 Pro</h1>
      <p>카메라 기반 손가락 패턴 인증 (MIT License)</p>
    </div>

    <div id="infoMessage" class="message info show">카메라를 켜고, 손가락을 네모 안에 맞춰보세요.</div>
    <div id="errorMessage" class="message error"></div>
    <div id="successMessage" class="message success"></div>

    <div id="videoContainer" class="video-container">
      <video id="video" autoplay playsinline muted></video>
      <div class="video-label">카메라 활성</div>
      <div id="fingerGuide" class="finger-guide state-idle"></div>
      <div id="statusBadge" class="status-badge">대기 중</div>
      <div id="authResult" class="auth-result">지문 인증 완료</div>
    </div>

    <canvas id="analyzeCanvas" width="160" height="120"></canvas>

    <div class="button-group">
      <button id="startBtn" class="btn-brand" onclick="startCamera()">시작</button>
      <button id="stopBtn" class="btn-cancel btn-disabled" onclick="stopCamera()">종료</button>
    </div>

    <div class="button-group">
      <button id="enrollBtn" class="btn-brand btn-disabled" onclick="enrollFinger()">기준 등록</button>
      <button id="verifyBtn" class="btn-brand btn-disabled" onclick="verifyFinger()">인증하기</button>
    </div>
  </div>

<script>
/* =========================================
   AILee v2 Pro - MIT License
   카메라 손가락 패턴 등록/인증 (완전 동작)
========================================= */

let stream=null;
let video=null;
let analyzeCanvas=null;
let analyzeCtx=null;
let analyzing=false;

let enrolledTemplate=null;
let lastQuality="bad";

const TEMPLATE = 32;
const MATCH_THRESHOLD = 15;

// 메시지 핸들링
function showInfo(t){infoMessage.textContent=t;infoMessage.classList.add("show");errorMessage.classList.remove("show");successMessage.classList.remove("show");}
function showErr(t){errorMessage.textContent=t;errorMessage.classList.add("show");successMessage.classList.remove("show");}
function showOk(t){successMessage.textContent=t;successMessage.classList.add("show");errorMessage.classList.remove("show");}
function clearMsgs(){infoMessage.classList.remove("show");errorMessage.classList.remove("show");successMessage.classList.remove("show");authResult.classList.remove("show");}

// 버튼 활성화
function setButtons(cameraOn){
  const startBtn=document.getElementById("startBtn");
  const stopBtn=document.getElementById("stopBtn");
  const enrollBtn=document.getElementById("enrollBtn");
  const verifyBtn=document.getElementById("verifyBtn");

  // 시작/종료
  startBtn.disabled = cameraOn;
  stopBtn.disabled  = !cameraOn;
  stopBtn.classList.toggle("btn-disabled", !cameraOn);

  // 기준 등록 버튼 = 카메라만 켜지면 항상 활성화
  enrollBtn.disabled = !cameraOn;
  enrollBtn.classList.toggle("btn-disabled", !cameraOn);

  // 인증하기 버튼 = 기준 템플릿이 존재해야 활성화
  const canVerify = cameraOn && enrolledTemplate;
  verifyBtn.disabled = !canVerify;
  verifyBtn.classList.toggle("btn-disabled", !canVerify);
}

// 카메라 시작
async function startCamera(){
  clearMsgs();
  showInfo("카메라 권한 요청 중...");

  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},
      audio:false
    });

    video=document.getElementById("video");
    video.srcObject=stream;
    await video.play();

    analyzeCanvas=document.getElementById("analyzeCanvas");
    analyzeCtx=analyzeCanvas.getContext("2d");

    document.getElementById("videoContainer").style.display="block";

    analyzing=true;
    analyze();
    showInfo("손가락을 네모 안에 맞춰주세요.");

    setButtons(true);

  }catch(e){
    showErr("카메라 오류: "+e.message);
  }
}

// 카메라 종료
function stopCamera(){
  analyzing=false;
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
  document.getElementById("videoContainer").style.display="none";
  showInfo("카메라를 종료했습니다.");
  setButtons(false);
  lastQuality="bad";
}

// 피부 판단 (간단 모델)
function isSkin(r,g,b){
  const mx=Math.max(r,g,b),mn=Math.min(r,g,b);
  return r>80 && g>40 && b>20 && r>=g && r>=b && (mx-mn)>15;
}

// 메인 분석 루프
function analyze(){
  if(!analyzing) return;

  if(video.readyState>=2){
    const w=analyzeCanvas.width,h=analyzeCanvas.height;
    analyzeCtx.drawImage(video,0,0,w,h);
    const data=analyzeCtx.getImageData(0,0,w,h).data;

    const rx=Math.floor(w*0.275),ry=Math.floor(h*0.275);
    const rw=Math.floor(w*0.45),rh=Math.floor(h*0.45);

    let skin=0,total=0;
    let borderSkin=0,centerSkin=0;

    const borderMargin=0.08;
    const centerRange=0.3;

    for(let y=ry;y<ry+rh;y++){
      for(let x=rx;x<rx+rw;x++){
        const idx=(y*w+x)*4;
        const r=data[idx],g=data[idx+1],b=data[idx+2];
        total++;
        if(!isSkin(r,g,b)) continue;

        skin++;

        const nx=(x-rx)/rw,ny=(y-ry)/rh;

        const isBorder = nx<borderMargin||nx>1-borderMargin||ny<borderMargin||ny>1-borderMargin;
        const isCenter = (
          nx>0.5-centerRange && nx<0.5+centerRange &&
          ny>0.5-centerRange && ny<0.5+centerRange
        );

        if(isBorder) borderSkin++;
        if(isCenter) centerSkin++;
      }
    }

    const skinRatio = skin / total;
    const borderRatio = borderSkin / Math.max(skin,1);
    const centerRatio = centerSkin / Math.max(skin,1);

    let status="bad",msg="";

    if(skinRatio<0.04){
      status="bad"; msg="손가락이 거의 보이지 않습니다.";
    }
    else if(centerRatio < 0.2){
      status="warn"; msg="손가락이 중앙에서 벗어났습니다.";
    }
    else if(borderRatio > 0.55){
      status="warn"; msg="너무 가까워 화면 가장자리가 잘립니다.";
    }
    else{
      status="good"; msg="좋은 위치입니다. 기준 등록이 가능합니다.";
    }

    lastQuality=status;

    fingerGuide.className = "finger-guide state-"+status;

    statusBadge.className =
      "status-badge " + (status==="good"?"good":status==="warn"?"warn":"bad");
    statusBadge.textContent =
      status==="good"?"품질 양호":status==="warn"?"조정 필요":"인식 약함";

    if(status==="good") showOk(msg);
    else showErr(msg);

    setButtons(true);
  }

  requestAnimationFrame(analyze);
}


// 기준 템플릿 추출
function captureTemplate(){
  const w=analyzeCanvas.width,h=analyzeCanvas.height;
  analyzeCtx.drawImage(video,0,0,w,h);
  const data=analyzeCtx.getImageData(0,0,w,h).data;

  const rx=Math.floor(w*0.275),ry=Math.floor(h*0.275);
  const rw=Math.floor(w*0.45),rh=Math.floor(h*0.45);

  const tpl=new Float32Array(TEMPLATE*TEMPLATE);

  const stepX=rw/TEMPLATE,stepY=rh/TEMPLATE;
  let i=0;

  for(let j=0;j<TEMPLATE;j++){
    for(let k=0;k<TEMPLATE;k++){
      const x=Math.floor(rx+k*stepX);
      const y=Math.floor(ry+j*stepY);
      const idx=(y*w+x)*4;
      const r=data[idx],g=data[idx+1],b=data[idx+2];
      const gray=0.299*r+0.587*g+0.114*b;
      tpl[i++] = gray;
    }
  }
  return tpl;
}


// 기준 등록
function enrollFinger(){
  enrolledTemplate = captureTemplate();

  if(lastQuality !== "good"){
    showErr("품질은 조금 아쉽지만, 기준을 등록했습니다.");
  } else {
    showOk("기준 등록 완료! 이제 인증하기를 눌러보세요.");
  }

  setButtons(true);
}


// 인증하기
function verifyFinger(){
  if(!enrolledTemplate){
    return showErr("먼저 기준 등록을 해주세요.");
  }

  const current = captureTemplate();
  let diff=0;

  for(let i=0;i<current.length;i++){
    diff+=Math.abs(current[i]-enrolledTemplate[i]);
  }
  diff/=current.length;

  if(diff < MATCH_THRESHOLD){
    showOk("인증 성공!");
    authResult.classList.add("show");
  } else {
    showErr("인증 실패 (차이: "+diff.toFixed(1)+")");
    authResult.classList.remove("show");
  }
}

window.addEventListener("unload",()=>{
  if(stream) stream.getTracks().forEach(t=>t.stop());
});
</script>

</body>
</html>

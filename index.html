<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¤– AILee - ì‹¤ì‹œê°„ ì†ê°€ë½ ì¸ì‹ & ê¸°ì¤€ ë“±ë¡/ì¸ì¦</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:#f5f5f5;
      padding:10px;
    }

    .container{
      max-width:480px;
      margin:0 auto;
      background:#fff;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      padding:20px;
    }

    .header{
      text-align:center;
      margin-bottom:16px;
      border-bottom:2px solid #0070d2;
      padding-bottom:10px;
    }

    .header h1{
      font-size:22px;
      color:#0070d2;
      margin-bottom:4px;
    }

    .header p{
      font-size:12px;
      color:#666;
    }

    .message{
      padding:10px 12px;
      margin-bottom:10px;
      border-radius:6px;
      font-size:13px;
      display:none;
      word-break:break-word;
    }
    .message.show{ display:block; }
    .message.info{ background:#e7f3ff; border-left:4px solid #0070d2; color:#0070d2; }
    .message.error{ background:#fef1f0; border-left:4px solid #c23030; color:#c23030; }
    .message.success{ background:#dffcf0; border-left:4px solid #04844b; color:#04844b; }

    .video-container{
      position:relative;
      width:100%;
      max-width:480px;
      margin:0 auto 12px;
      background:#000;
      border-radius:10px;
      overflow:hidden;
      display:none;
    }

    video{
      width:100%;
      height:auto;
      display:block;
      object-fit:contain;
      background:#000;
    }

    .video-label{
      position:absolute;
      top:8px;
      left:8px;
      padding:4px 8px;
      border-radius:4px;
      background:rgba(0,0,0,0.6);
      color:#eee;
      font-size:11px;
      pointer-events:none;
    }

    .finger-guide{
      position:absolute;
      top:50%;
      left:50%;
      width:45%;
      height:45%;
      transform:translate(-50%,-50%);
      border-radius:12px;
      border:3px dashed rgba(255,255,255,0.9);
      box-shadow:0 0 0 2px rgba(0,0,0,0.3);
      pointer-events:none;
      transition:border-color .15s ease,box-shadow .15s ease,background-color .15s ease;
    }
    .finger-guide.state-idle{ border-color:rgba(255,255,255,0.9); background:transparent; }
    .finger-guide.state-good{ border-color:#00c853; box-shadow:0 0 0 2px rgba(0,200,83,0.4); background:rgba(0,200,83,0.08); }
    .finger-guide.state-warn{ border-color:#ffb300; box-shadow:0 0 0 2px rgba(255,179,0,0.4); background:rgba(255,179,0,0.08); }
    .finger-guide.state-bad{ border-color:#e53935; box-shadow:0 0 0 2px rgba(229,57,53,0.4); background:rgba(229,57,53,0.05); }

    .status-badge{
      position:absolute;
      bottom:8px;
      right:8px;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      color:#fff;
      background:rgba(0,0,0,0.65);
      pointer-events:none;
    }
    .status-badge.good{ background:rgba(0,200,83,0.9); }
    .status-badge.warn{ background:rgba(255,179,0,0.9); }
    .status-badge.bad{ background:rgba(229,57,53,0.9); }

    .button-group{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }

    button{
      padding:10px 14px;
      border:none;
      border-radius:6px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:background .15s ease,transform .05s ease;
      min-height:44px;
    }
    button:active{ transform:scale(0.98); }

    .btn-brand{ background:#0070d2; color:#fff; }
    .btn-brand:hover{ background:#005bb5; }
    .btn-cancel{ background:#e0e0e0; color:#333; }
    .btn-cancel:hover{ background:#d0d0d0; }

    .btn-disabled{
      background:#ccc !important;
      cursor:not-allowed !important;
    }

    .hint{
      font-size:11px;
      color:#777;
      margin-bottom:8px;
    }

    .guide{
      background:#f0f4f8;
      border-left:4px solid #0070d2;
      border-radius:6px;
      padding:12px;
      margin-top:12px;
    }
    .guide-title{ font-size:13px; font-weight:bold; margin-bottom:6px; color:#333; }
    .guide-list{ list-style:none; padding-left:0; }
    .guide-list li{
      font-size:12px; color:#555;
      margin-bottom:6px;
      padding-left:18px;
      position:relative;
    }
    .guide-list li::before{
      content:"â€¢";
      position:absolute;
      left:4px;
    }

    #analyzeCanvas{ display:none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤– AILee - ì‹¤ì‹œê°„ ì†ê°€ë½ ì¸ì‹</h1>
      <p>ì†ê°€ë½ ìœ„ì¹˜Â·ê±°ë¦¬ í’ˆì§ˆ ì²´í¬ + ê¸°ì¤€ ë“±ë¡/ì¸ì¦ ë°ëª¨</p>
    </div>

    <!-- ë©”ì‹œì§€ -->
    <div id="infoMessage" class="message info show">
      ì¹´ë©”ë¼ë¥¼ ì¼œê³ , ì†ê°€ë½ì„ ê°€ìš´ë° ë„¤ëª¨ì— ë§ì¶”ë©´ í’ˆì§ˆê³¼ ì¸ì¦ ìƒíƒœë¥¼ ì•Œë ¤ì¤„ê²Œìš”.
    </div>
    <div id="errorMessage" class="message error"></div>
    <div id="successMessage" class="message success"></div>

    <!-- ë¹„ë””ì˜¤ -->
    <div id="videoContainer" class="video-container">
      <video id="video" autoplay playsinline muted></video>
      <div class="video-label">ğŸ“· ì¹´ë©”ë¼ í™œì„± ì¤‘</div>
      <div id="fingerGuide" class="finger-guide state-idle"></div>
      <div id="statusBadge" class="status-badge">ëŒ€ê¸° ì¤‘</div>
    </div>

    <!-- ë¶„ì„ìš© ìº”ë²„ìŠ¤ -->
    <canvas id="analyzeCanvas" width="160" height="120"></canvas>

    <!-- ì¹´ë©”ë¼ on/off -->
    <div class="button-group">
      <button id="startBtn" class="btn-brand" onclick="startCamera()">ğŸ“· ì‹œì‘</button>
      <button id="stopBtn" class="btn-cancel btn-disabled" onclick="stopCamera()" disabled>âŒ ì¢…ë£Œ</button>
    </div>

    <!-- ê¸°ì¤€ ë“±ë¡ / ì¸ì¦ -->
    <div class="button-group">
      <button id="enrollBtn" class="btn-brand btn-disabled" onclick="enrollFinger()" disabled>ğŸ“Œ ê¸°ì¤€ ë“±ë¡</button>
      <button id="verifyBtn" class="btn-brand btn-disabled" onclick="verifyFinger()" disabled>âœ… ì¸ì¦í•˜ê¸°</button>
    </div>

    <div class="hint">
      âš ï¸ ì¼ë°˜ ì¹´ë©”ë¼ë¼ì„œ ì§€ë¬¸ì„ ê¹Œì§€ ì™„ë²½í•˜ê²Œ ë³´ê¸´ ì–´ë µê³ ,<br/>
      ì´ ë°ëª¨ëŠ” â€œì†ê°€ë½ ìœ„ì¹˜Â·ê±°ë¦¬ í’ˆì§ˆ + ë“±ë¡/ì¸ì¦ íë¦„â€ë§Œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ìš©ë„ì•¼.
    </div>

    <div class="guide">
      <div class="guide-title">â„¹ï¸ ì‚¬ìš© ê°€ì´ë“œ</div>
      <ul class="guide-list">
        <li>ğŸ“· <b>ì‹œì‘</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¹´ë©”ë¼ë¥¼ ì¼­ë‹ˆë‹¤.</li>
        <li>ì†ê°€ë½ì„ <b>ê°€ìš´ë° ë„¤ëª¨ ë°•ìŠ¤ ì•ˆ</b>ì— ë§ì¶”ê³ , ì´ˆë¡ìƒ‰ì´ ë˜ë„ë¡ ê±°ë¦¬/ìœ„ì¹˜ë¥¼ ì¡°ì •í•©ë‹ˆë‹¤.</li>
        <li>ì´ˆë¡ìƒ‰ì´ ë˜ë©´ <b>[ğŸ“Œ ê¸°ì¤€ ë“±ë¡]</b>ì„ ëˆŒëŸ¬ í˜„ì¬ ì†ê°€ë½ì„ ë“±ë¡í•©ë‹ˆë‹¤.</li>
        <li>ì´í›„ ê°™ì€ ì†ê°€ë½ì„ ë‹¤ì‹œ ë„¤ëª¨ ì•ˆì— ë§ì¶”ê³  <b>[âœ… ì¸ì¦í•˜ê¸°]</b>ë¥¼ ëˆŒëŸ¬ ë“±ë¡ëœ ì†ê°€ë½ê³¼ ë¹„êµí•©ë‹ˆë‹¤.</li>
      </ul>
    </div>
  </div>

  <script>
    let stream = null;
    let video = null;
    let analyzeCanvas = null;
    let analyzeCtx = null;
    let analyzing = false;

    // ë“±ë¡ëœ ì†ê°€ë½ í…œí”Œë¦¿ + í’ˆì§ˆ ìƒíƒœ
    let enrolledTemplate = null;
    let lastQualityStatus = 'bad'; // good / warn / bad

    const TEMPLATE_SIZE = 32;
    const MATCH_THRESHOLD = 15; // ì‘ì„ìˆ˜ë¡ ì—„ê²©

    const infoMessage = document.getElementById("infoMessage");
    const errorMessage = document.getElementById("errorMessage");
    const successMessage = document.getElementById("successMessage");
    const videoContainer = document.getElementById("videoContainer");
    const fingerGuide = document.getElementById("fingerGuide");
    const statusBadge = document.getElementById("statusBadge");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const enrollBtn = document.getElementById("enrollBtn");
    const verifyBtn = document.getElementById("verifyBtn");

    function setInfo(msg){
      infoMessage.textContent = msg;
      infoMessage.classList.add("show");
    }
    function clearInfo(){ infoMessage.classList.remove("show"); }
    function setError(msg){
      errorMessage.textContent = msg;
      errorMessage.classList.add("show");
    }
    function clearError(){ errorMessage.classList.remove("show"); }
    function setSuccess(msg){
      successMessage.textContent = msg;
      successMessage.classList.add("show");
    }
    function clearSuccess(){ successMessage.classList.remove("show"); }

    function setButtons(running){
      if(running){
        startBtn.classList.add("btn-disabled");
        startBtn.disabled = true;
        stopBtn.classList.remove("btn-disabled");
        stopBtn.disabled = false;
      }else{
        startBtn.classList.remove("btn-disabled");
        startBtn.disabled = false;
        stopBtn.classList.add("btn-disabled");
        stopBtn.disabled = true;
      }
      updateEnrollVerifyButtons();
    }

    function updateEnrollVerifyButtons(){
      // ì¹´ë©”ë¼ê°€ êº¼ì ¸ ìˆìœ¼ë©´ ë‘˜ ë‹¤ ë¹„í™œì„±í™”
      if(!stream){
        enrollBtn.disabled = true;
        enrollBtn.classList.add("btn-disabled");
        verifyBtn.disabled = true;
        verifyBtn.classList.add("btn-disabled");
        return;
      }

      // í’ˆì§ˆì´ goodì¼ ë•Œë§Œ ë“±ë¡ ë²„íŠ¼ í™œì„±í™”
      if(lastQualityStatus === 'good'){
        enrollBtn.disabled = false;
        enrollBtn.classList.remove("btn-disabled");
      }else{
        enrollBtn.disabled = true;
        enrollBtn.classList.add("btn-disabled");
      }

      // ë“±ë¡ëœ í…œí”Œë¦¿ì´ ìˆê³  í’ˆì§ˆì´ goodì¼ ë•Œë§Œ ì¸ì¦ ë²„íŠ¼ í™œì„±í™”
      if(enrolledTemplate && lastQualityStatus === 'good'){
        verifyBtn.disabled = false;
        verifyBtn.classList.remove("btn-disabled");
      }else{
        verifyBtn.disabled = true;
        verifyBtn.classList.add("btn-disabled");
      }
    }

    async function startCamera(){
      try{
        clearError(); clearSuccess();
        setInfo("ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...");

        const constraints = {
          video:{
            facingMode:{ ideal:"environment" },
            width:{ ideal:1920 },
            height:{ ideal:1080 }
          },
          audio:false
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video = document.getElementById("video");
        analyzeCanvas = document.getElementById("analyzeCanvas");
        analyzeCtx = analyzeCanvas.getContext("2d");

        video.srcObject = stream;
        await video.play();

        videoContainer.style.display = "block";
        analyzing = true;
        setButtons(true);
        setInfo("ì†ê°€ë½ì„ ê°€ìš´ë° ë„¤ëª¨ì— ë§ì¶”ë©´ í’ˆì§ˆê³¼ ë“±ë¡/ì¸ì¦ ìƒíƒœë¥¼ ì•Œë ¤ì¤ë‹ˆë‹¤.");
        requestAnimationFrame(analyzeLoop);
      }catch(err){
        console.error(err);
        setError("ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + err.message);
        setButtons(false);
      }
    }

    function stopCamera(){
      analyzing = false;
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      if(video){ video.srcObject = null; }
      videoContainer.style.display = "none";
      fingerGuide.className = "finger-guide state-idle";
      statusBadge.className = "status-badge";
      statusBadge.textContent = "ëŒ€ê¸° ì¤‘";
      lastQualityStatus = 'bad';
      setButtons(false);
      setInfo("ì¹´ë©”ë¼ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ [ì‹œì‘]ì„ ëˆ„ë¥´ì„¸ìš”.");
      clearError();
      // ë“±ë¡ëœ í…œí”Œë¦¿ì€ ìœ ì§€ (ì›í•˜ë©´ stop ì‹œ ì´ˆê¸°í™”í•  ìˆ˜ë„ ìˆìŒ)
    }

    // ì•„ì£¼ ë‹¨ìˆœí•œ í”¼ë¶€ìƒ‰ íŒë‹¨
    function isSkinPixel(r,g,b){
      const max = Math.max(r,g,b);
      const min = Math.min(r,g,b);
      const diff = max - min;
      return (
        r>80 && g>40 && b>20 &&
        r>=g && r>=b &&
        diff>15 &&
        !(r>230 && g>230 && b>230)
      );
    }

    function analyzeLoop(){
      if(!analyzing || !video || video.readyState<2){
        if(analyzing) requestAnimationFrame(analyzeLoop);
        return;
      }

      const w = analyzeCanvas.width;
      const h = analyzeCanvas.height;
      analyzeCtx.drawImage(video,0,0,w,h);
      const frame = analyzeCtx.getImageData(0,0,w,h);
      const data = frame.data;

      const roiX = Math.floor(w*0.275);
      const roiY = Math.floor(h*0.275);
      const roiW = Math.floor(w*0.45);
      const roiH = Math.floor(h*0.45);

      let skinCount=0, totalCount=0;
      let minX=roiW, maxX=0, minY=roiH, maxY=0;

      for(let y=roiY; y<roiY+roiH; y++){
        for(let x=roiX; x<roiX+roiW; x++){
          const idx = (y*w + x)*4;
          const r=data[idx], g=data[idx+1], b=data[idx+2];
          totalCount++;
          if(isSkinPixel(r,g,b)){
            skinCount++;
            const lx = x-roiX;
            const ly = y-roiY;
            if(lx<minX) minX=lx;
            if(lx>maxX) maxX=lx;
            if(ly<minY) minY=ly;
            if(ly>maxY) maxY=ly;
          }
        }
      }

      const skinRatio = skinCount/totalCount;
      let status = "bad";
      let reason = "";
      let badgeClass = "status-badge bad";

      if(skinRatio < 0.05){
        status = "bad";
        reason = "ì†ê°€ë½ì´ ì˜ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë„¤ëª¨ ì•ˆìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ë§ì¶”ê±°ë‚˜ ì¡°ê¸ˆ ë” ê°€ê¹Œì´ ê°€ì ¸ì™€ ì£¼ì„¸ìš”.";
      }else{
        const width = maxX - minX;
        const height = maxY - minY;
        const area = width * height;
        const roiArea = roiW * roiH;
        const areaRatio = area / roiArea;

        const centerX = (minX + maxX)/2;
        const centerY = (minY + maxY)/2;
        const normX = centerX/roiW;
        const normY = centerY/roiH;
        const centerTooOff = Math.abs(normX-0.5)>0.2 || Math.abs(normY-0.5)>0.2;

        if(centerTooOff){
          status = "warn";
          reason = "ì†ê°€ë½ ìœ„ì¹˜ê°€ ê°€ìš´ë°ì—ì„œ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ë„¤ëª¨ ì¤‘ì•™ìœ¼ë¡œ ë§ì¶° ì£¼ì„¸ìš”.";
          badgeClass = "status-badge warn";
        }else if(areaRatio < 0.15){
          status = "warn";
          reason = "ì†ê°€ë½ì´ ë„ˆë¬´ ë©€ë¦¬ ìˆìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ìª½ìœ¼ë¡œ ì¡°ê¸ˆ ë” ê°€ê¹Œì´ ê°€ì ¸ì™€ ì£¼ì„¸ìš”.";
          badgeClass = "status-badge warn";
        }else if(areaRatio > 0.50){
          status = "warn";
          reason = "ì†ê°€ë½ì´ ë„ˆë¬´ ê°€ê¹ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ì—ì„œ ì•½ê°„ ë©€ë¦¬ ë–¼ì–´ ì£¼ì„¸ìš”.";
          badgeClass = "status-badge warn";
        }else{
          status = "good";
          reason = "ì§€ë¬¸ì„ ì´¬ì˜í•˜ê¸°ì— ì¢‹ì€ ìœ„ì¹˜ì…ë‹ˆë‹¤. ì´ ìƒíƒœì—ì„œ [ê¸°ì¤€ ë“±ë¡]ì„ ëˆŒëŸ¬ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
          badgeClass = "status-badge good";
        }
      }

      lastQualityStatus = status; // ğŸ”¹ í’ˆì§ˆ ìƒíƒœ ì €ì¥

      fingerGuide.classList.remove("state-idle","state-good","state-warn","state-bad");
      if(status==="good"){
        fingerGuide.classList.add("state-good");
        setSuccess(reason);
        clearError();
      }else if(status==="warn"){
        fingerGuide.classList.add("state-warn");
        clearSuccess();
        setError(reason);
      }else{
        fingerGuide.classList.add("state-bad");
        clearSuccess();
        setError(reason);
      }

      statusBadge.className = badgeClass;
      statusBadge.textContent =
        status==="good" ? "í’ˆì§ˆ ì–‘í˜¸ (ë“±ë¡ ê°€ëŠ¥)" :
        status==="warn" ? "ì¡°ì • í•„ìš”" :
        "ì†ê°€ë½ ì¸ì‹ ì•½í•¨";

      updateEnrollVerifyButtons();

      if(analyzing) requestAnimationFrame(analyzeLoop);
    }

    // í˜„ì¬ í”„ë ˆì„ì˜ ROIë¥¼ ì‘ì€ í…œí”Œë¦¿(32x32 gray)ìœ¼ë¡œ ì¶”ì¶œ
    function captureTemplateFromCurrentFrame(){
      const w = analyzeCanvas.width;
      const h = analyzeCanvas.height;
      analyzeCtx.drawImage(video,0,0,w,h);
      const frame = analyzeCtx.getImageData(0,0,w,h);
      const data = frame.data;

      const roiX = Math.floor(w*0.275);
      const roiY = Math.floor(h*0.275);
      const roiW = Math.floor(w*0.45);
      const roiH = Math.floor(h*0.45);

      const tpl = new Float32Array(TEMPLATE_SIZE*TEMPLATE_SIZE);
      const stepX = roiW / TEMPLATE_SIZE;
      const stepY = roiH / TEMPLATE_SIZE;

      let idxTpl = 0;
      for(let j=0; j<TEMPLATE_SIZE; j++){
        for(let i=0; i<TEMPLATE_SIZE; i++){
          const x = Math.floor(roiX + i*stepX);
          const y = Math.floor(roiY + j*stepY);
          const idx = (y*w + x)*4;
          const r=data[idx], g=data[idx+1], b=data[idx+2];
          const gray = 0.299*r + 0.587*g + 0.114*b;
          tpl[idxTpl++] = gray;
        }
      }
      return tpl;
    }

    function templateDistance(a,b){
      if(!a || !b || a.length!==b.length) return Infinity;
      let sum = 0;
      for(let i=0;i<a.length;i++){
        sum += Math.abs(a[i]-b[i]);
      }
      return sum / a.length;
    }

    // ê¸°ì¤€ ë“±ë¡
    function enrollFinger(){
      clearError(); clearSuccess();
      if(!stream){
        setError("ì¹´ë©”ë¼ê°€ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € [ì‹œì‘]ì„ ëˆŒëŸ¬ ì¹´ë©”ë¼ë¥¼ ì¼œ ì£¼ì„¸ìš”.");
        return;
      }
      if(lastQualityStatus !== 'good'){
        setError("ì†ê°€ë½ í’ˆì§ˆì´ ì¢‹ì§€ ì•ŠìŠµë‹ˆë‹¤. ë„¤ëª¨ê°€ ì´ˆë¡ìƒ‰ì´ ëœ ìƒíƒœì—ì„œ ë‹¤ì‹œ ë“±ë¡í•´ ì£¼ì„¸ìš”.");
        return;
      }

      enrolledTemplate = captureTemplateFromCurrentFrame();
      setSuccess("í˜„ì¬ ì†ê°€ë½ì„ ê¸°ì¤€ìœ¼ë¡œ ë“±ë¡í–ˆìŠµë‹ˆë‹¤. ê°™ì€ ì†ê°€ë½ì¸ì§€ [ì¸ì¦í•˜ê¸°]ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      setInfo("ì´ì œ ê°™ì€ ì†ê°€ë½ì„ ë‹¤ì‹œ ë„¤ëª¨ì— ë§ì¶”ê³  [ì¸ì¦í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.");
      updateEnrollVerifyButtons();
    }

    // ì¸ì¦
    function verifyFinger(){
      clearError(); clearSuccess();
      if(!enrolledTemplate){
        setError("ë“±ë¡ëœ ê¸°ì¤€ ì†ê°€ë½ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € [ê¸°ì¤€ ë“±ë¡]ì„ ëˆŒëŸ¬ ë“±ë¡í•´ ì£¼ì„¸ìš”.");
        return;
      }
      if(!stream){
        setError("ì¹´ë©”ë¼ê°€ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤. [ì‹œì‘] ë²„íŠ¼ìœ¼ë¡œ ì¹´ë©”ë¼ë¥¼ ì¼œ ì£¼ì„¸ìš”.");
        return;
      }
      if(lastQualityStatus !== 'good'){
        setError("ì†ê°€ë½ í’ˆì§ˆì´ ì¢‹ì§€ ì•ŠìŠµë‹ˆë‹¤. ë„¤ëª¨ê°€ ì´ˆë¡ìƒ‰ì´ ëœ ìƒíƒœì—ì„œ ì¸ì¦ì„ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        return;
      }

      setInfo("ë“±ë¡ëœ ê¸°ì¤€ê³¼ í˜„ì¬ ì†ê°€ë½ì„ ë¹„êµ ì¤‘ì…ë‹ˆë‹¤...");
      const currentTemplate = captureTemplateFromCurrentFrame();
      const dist = templateDistance(enrolledTemplate, currentTemplate);

      if(dist < MATCH_THRESHOLD){
        setSuccess(`ì¸ì¦ ì„±ê³µ: ë“±ë¡ëœ ì†ê°€ë½ê³¼ ìœ ì‚¬ë„ê°€ ë†’ìŠµë‹ˆë‹¤. (ê±°ë¦¬ ${dist.toFixed(1)})`);
      }else{
        setError(`ì¸ì¦ ì‹¤íŒ¨: ë“±ë¡ëœ ì†ê°€ë½ê³¼ ì°¨ì´ê°€ í½ë‹ˆë‹¤. (ê±°ë¦¬ ${dist.toFixed(1)})`);
      }
    }

    window.addEventListener("unload", () => {
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>실시간 지문 분석 시각화</title>
  <script src="https://docs.opencv.org/4.x/opencv.js"></script>
  <style>
    body{margin:0;background:#000;color:#0f0;font-family:monospace;text-align:center;padding:10px;}
    .row{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin:10px 0;}
    .box{background:#111;border:2px solid #0f0;border-radius:12px;padding:10px;position:relative;}
    video,canvas{width:100%;max-width:420px;border-radius:10px;}
    h3{margin:5px 0;color:#0f0;}
    .step{font-size:14px;margin:5px;}
    .points circle{fill:#0ff;stroke:#000;stroke-width:2;}
    #overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
             width:220px;height:340px;border:4px dashed #0f0;border-radius:30px;pointer-events:none;}
  </style>
</head>
<body>
  <h2>실시간 지문 분석 과정 보기</h2>
  <div style="position:relative;display:inline-block;">
    <video id="v" autoplay playsinline muted></video>
    <div id="overlay"></div>
  </div>

  <div class="row">
    <div class="box">
      <h3>1. 원본 손가락</h3>
      <canvas id="orig"></canvas>
    </div>
    <div class="box">
      <h3>2. 선명도 강화</h3>
      <canvas id="sharp"></canvas>
    </div>
  </div>

  <div class="row">
    <div class="box">
      <h3>3. 이진화 (능선만)</h3>
      <canvas id="bin"></canvas>
    </div>
    <div class="box">
      <h3>4. 스켈레톤</h3>
      <canvas id="skel"></canvas>
    </div>
  </div>

  <div class="row">
    <div class="box">
      <h3>5. 특징점 실시간 추출</h3>
      <canvas id="points"></canvas>
      <div class="step" id="count">특징점: 0개</div>
    </div>
  </div>

  <div style="margin:20px;">
    <button onclick="reg()" style="padding:15px 30px;font-size:20px;background:#e74c3c;color:#fff;border:none;border-radius:12px;">지문 등록</button>
    <button onclick="auth()" id="authBtn" disabled style="padding:15px 30px;font-size:20px;background:#27ae60;color:#fff;border:none;border-radius:12px;">지문 인증</button>
  </div>
  <div id="result" style="font-size:28px;font-weight:bold;margin:20px;"></div>

  <script>
    const v = document.getElementById('v');
    const canvases = {
      orig: document.getElementById('orig'),
      sharp: document.getElementById('sharp'),
      bin: document.getElementById('bin'),
      skel: document.getElementById('skel'),
      points: document.getElementById('points')
    };
    Object.values(canvases).forEach(c => c.width = 400);

    async function start() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {facingMode:"environment", width:{ideal:1920}}
      });
      v.srcObject = stream;
      v.onloadedmetadata = () => loop();
    }

    function loop() {
      if (!v.videoWidth) return requestAnimationFrame(loop);
      const src = cv.imread(v);
      
      // 1. 중앙 손가락 영역 자르기
      const roi = new cv.Rect(src.cols*0.35, src.rows*0.25, src.cols*0.3, src.rows*0.5);
      const finger = src.roi(roi);
      cv.imshow(canvases.orig, finger);

      // 2. 선명도 강화 (언샤프 마스크)
      const blurred = new cv.Mat();
      cv.GaussianBlur(finger, blurred, new cv.Size(0,0), 3);
      const sharp = new cv.Mat();
      cv.addWeighted(finger, 1.9, blurred, -0.9, 0, sharp);
      cv.imshow(canvases.sharp, sharp);

      // 3. 이진화
      const gray = new cv.Mat();
      cv.cvtColor(sharp, gray, cv.COLOR_RGBA2GRAY);
      const bin = new cv.Mat();
      cv.threshold(gray, bin, 0, 255, cv.THRESH_OTSU);
      cv.imshow(canvases.bin, bin);

      // 4. 스켈레톤화
      const skel = new cv.Mat();
      cv.ximgproc.thinning(bin, skel);
      cv.imshow(canvases.skel, skel);

      // 5. 특징점 추출 + 시각화
      const points = getMinutiae(skel);
      const ptsCanvas = canvases.points;
      const ctx = ptsCanvas.getContext('2d');
      ctx.clearRect(0,0,ptsCanvas.width,ptsCanvas.height);
      ctx.drawImage(canvases.skel, 0, 0, ptsCanvas.width, ptsCanvas.height);
      ctx.fillStyle = '#0ff';
      points.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x*(ptsCanvas.width/skel.cols), p.y*(ptsCanvas.height/skel.rows), 6, 0, Math.PI*2);
        ctx.fill();
      });

      document.getElementById('count').textContent = `특징점: ${points.length}개`;
      if (points.length > 35) {
        window.currentPoints = points;
        document.getElementById('authBtn').disabled = false;
      }

      // 메모리 정리
      src.delete(); finger.delete(); blurred.delete(); sharp.delete(); 
      gray.delete(); bin.delete(); skel.delete();
      requestAnimationFrame(loop);
    }

    function getMinutiae(mat) {
      const pts = [], d = mat.data, w = mat.cols, h = mat.rows;
      for (let y=10; y<h-10; y++) for (let x=10; x<w-10; x++) {
        if (d[y*w+x]===255) {
          let n=0;
          for (let dy=-1;dy<=1;dy++) for (let dx=-1;dx<=1;dx++)
            if (dx||dy) n += d[(y+dy)*w+(x+dx)]===255;
          if (n===1 || n===3) pts.push({x,y});
        }
      }
      return pts;
    }

    function match(a,b) {
      let m=0;
      for (const p of a) for (const q of b)
        if (Math.hypot(p.x-q.x, p.y-q.y)<22) {m++; break;}
      return m / Math.max(a.length,b.length);
    }

    function reg() {
      localStorage.setItem('fp', JSON.stringify(window.currentPoints));
      document.getElementById('result').innerHTML = '<span style="color:#0f0">등록 완료!</span>';
    }

    function auth() {
      const saved = JSON.parse(localStorage.getItem('fp')||'[]');
      if (!saved.length) return alert('등록된 지문 없음');
      const score = match(window.currentPoints, saved);
      document.getElementById('result').innerHTML = score > 0.6 
        ? `<span style="color:#0f0">인증 성공! ${(score*100).toFixed(1)}%</span>`
        : `<span style="color:#f00">인증 실패 ${(score*100).toFixed(1)}%</span>`;
    }

    cv.onRuntimeInitialized = start;
  </script>
</body>
</html>

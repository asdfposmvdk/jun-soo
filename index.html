<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AILee - ìƒì²´ì¸ì‹ ì¸ì¦ ë°ëª¨</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:#f5f5f5;
      padding:16px;
    }
    .container{
      max-width:480px;
      margin:0 auto;
      background:#fff;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      padding:20px;
    }
    .header{
      text-align:center;
      margin-bottom:16px;
      border-bottom:2px solid #0070d2;
      padding-bottom:10px;
    }
    .header h1{
      font-size:20px;
      color:#0070d2;
      margin-bottom:4px;
    }
    .header p{
      font-size:12px;
      color:#666;
    }
    .section{
      margin-bottom:16px;
    }
    .message{
      font-size:12px;
      padding:8px 10px;
      border-radius:6px;
      margin-bottom:8px;
      display:none;
      word-break:break-word;
    }
    .message.show{display:block;}
    .message.info{
      background:#e7f3ff;
      border-left:4px solid #0070d2;
      color:#0070d2;
    }
    .message.error{
      background:#fef1f0;
      border-left:4px solid #c23030;
      color:#c23030;
    }
    .message.success{
      background:#dffcf0;
      border-left:4px solid #04844b;
      color:#04844b;
    }
    button{
      width:100%;
      padding:11px 14px;
      border:none;
      border-radius:6px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      background:#0070d2;
      color:#fff;
      transition:.15s;
    }
    button:disabled{
      background:#ccc;
      cursor:not-allowed;
    }
    button:active{
      transform:scale(.98);
    }
    .next-step{
      margin-top:12px;
      padding:10px 12px;
      border-radius:6px;
      background:#f5f7fb;
      font-size:13px;
      color:#333;
      display:none;
    }
    .next-step-title{
      font-weight:700;
      margin-bottom:6px;
    }
    .hint{
      font-size:11px;
      color:#777;
      margin-top:8px;
      line-height:1.4;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>AILee - ìƒì²´ì¸ì‹ ì¸ì¦</h1>
      <p>ì§€ë¬¸ / Face ID / PIN ë“± ê¸°ê¸° ìƒì²´ì¸ì‹ì„ í†µí•´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰</p>
    </div>

    <!-- ìƒíƒœ ë©”ì‹œì§€ -->
    <div id="msg" class="message info show">
      [ìƒì²´ì¸ì‹ìœ¼ë¡œ í™•ì¸] ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, ê¸°ê¸°ì— ë“±ë¡ëœ ì§€ë¬¸/Face ID ë“±ìœ¼ë¡œ ì¸ì¦ì„ ì§„í–‰í•©ë‹ˆë‹¤.
    </div>

    <!-- 1ë‹¨ê³„: ìƒì²´ì¸ì‹ ë²„íŠ¼ -->
    <div class="section">
      <button id="bioBtn" onclick="startBiometricAuth()">ğŸ” ìƒì²´ì¸ì‹ìœ¼ë¡œ í™•ì¸</button>
    </div>

    <!-- 2ë‹¨ê³„: ì¸ì¦ ì„±ê³µ í›„ ë…¸ì¶œë  ì˜ì—­ -->
    <div id="nextStep" class="next-step">
      <div class="next-step-title">âœ… ìƒì²´ì¸ì‹ ì¸ì¦ ì™„ë£Œ</div>
      <p>ì´ì œ ë‹¤ìŒ ë‹¨ê³„ í™”ë©´ìœ¼ë¡œ ë„˜ì–´ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <p style="margin-top:6px;">ì—¬ê¸°ì— ì¶œê·¼ ì²˜ë¦¬, ë¯¼ê° ì •ë³´ í‘œì‹œ, ê²°ì¬ í™”ë©´ ì´ë™ ë“± ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì—°ê²°í•˜ë©´ ë©ë‹ˆë‹¤.</p>
      <!-- í•„ìš”í•˜ë©´ ì‹¤ì œ í˜ì´ì§€ ì´ë™
      <button style="margin-top:10px;background:#04844b;" onclick="location.href='next.html'">
        ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
      </button>
      -->
    </div>

    <div class="hint">
      ğŸ“Œ ì°¸ê³ <br>
      - ì‹¤ì œ ì§€ë¬¸/Face ID ì¸ì¦ì€ WebAuthn / ê¸°ê¸° ìƒì²´ì¸ì‹ APIë¥¼ ì´ìš©í•´ì•¼ í•˜ë©°,<br>
      - ì´ ë°ëª¨ëŠ” êµ¬ì¡°ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ ì¼ë¶€ ë¡œì§ì„ ê°„ë‹¨íˆ/ê°€ìƒìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.<br>
      - ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì„œë²„ì—ì„œ challengeë¥¼ ë°œê¸‰ë°›ê³ , <code>navigator.credentials.get()</code>ë¡œ ê²€ì¦í•´ì•¼ í•©ë‹ˆë‹¤.
    </div>
  </div>

  <script>
    const msgEl = document.getElementById('msg');
    const bioBtn = document.getElementById('bioBtn');
    const nextStepEl = document.getElementById('nextStep');

    function setMessage(type, text) {
      msgEl.textContent = text;
      msgEl.classList.add('show');
      msgEl.classList.remove('info', 'error', 'success');
      if (type === 'info')   msgEl.classList.add('info');
      if (type === 'error')  msgEl.classList.add('error');
      if (type === 'success')msgEl.classList.add('success');
    }

    async function startBiometricAuth() {
      // WebAuthn ì§€ì› ì—¬ë¶€ ì²´í¬
      if (!window.PublicKeyCredential) {
        setMessage('error', 'ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” WebAuthn(ìƒì²´ì¸ì‹ ê¸°ë°˜ ì›¹ ì¸ì¦)ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      bioBtn.disabled = true;
      setMessage('info', 'ìƒì²´ì¸ì‹ ì¸ì¦ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...');

      try {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // âš  ì‹¤ì œ WebAuthn ì‚¬ìš© ì‹œì—ëŠ” ì—¬ê¸°ì—ì„œ:
        //  1) ì„œë²„ì— /webauthn/assertion-options ê°™ì€ APIë¡œ ìš”ì²­
        //  2) ì„œë²„ê°€ challenge + ë“±ë¡ëœ credentialId ë“±ì„ í¬í•¨í•œ publicKey ì˜µì…˜ì„ ë°˜í™˜
        //  3) navigator.credentials.get({ publicKey: ... }) í˜¸ì¶œ
        //  4) ë°˜í™˜ëœ assertionì„ ì„œë²„ë¡œ ë³´ë‚´ì„œ ê²€ì¦
        // ë¥¼ í•´ì•¼ í•©ë‹ˆë‹¤.
        //
        // ì´ ë°ëª¨ì—ì„œëŠ” OS ìƒì²´ì¸ì‹ ì°½ì„ ë„ìš°ëŠ” ëŒ€ì‹ ,
        // "ìƒì²´ì¸ì‹ ì¸ì¦ì´ ë˜ì—ˆë‹¤ê³  ê°€ì •"í•˜ê³  ì„±ê³µ íë¦„ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // â–½ ì—¬ê¸°ë¶€í„°ëŠ” "ê°€ì§œ ì¸ì¦" (ì‹¤ì œ ë°°í¬ ì‹œ ë°˜ë“œì‹œ WebAuthn ì½”ë“œë¡œ êµì²´)
        await new Promise(resolve => setTimeout(resolve, 800)); // ì‚´ì§ ë”œë ˆì´
        const fakeSuccess = true; // ì—¬ê¸°ì„œ true/falseë¡œ íë¦„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

        if (fakeSuccess) {
          setMessage('success', 'ìƒì²´ì¸ì‹ ì¸ì¦ì´ ì„±ê³µí–ˆë‹¤ê³  ê°€ì •í•œ ë°ëª¨ì…ë‹ˆë‹¤. (ì‹¤ì œ WebAuthn ì—°ë™ í•„ìš”)');
          nextStepEl.style.display = 'block';
        } else {
          setMessage('error', 'ìƒì²´ì¸ì‹ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        }

        // â–½ ì‹¤ì œ ì½”ë“œ ì˜ˆì‹œ êµ¬ì¡° (ì°¸ê³ ìš©, ë™ì‘X)
        /*
        const optionsFromServer = await fetch('/webauthn/assertion-options').then(r => r.json());

        // ì„œë²„ì—ì„œ ë°›ì€ challenge, allowCredentials ë“±ì„ ArrayBufferë¡œ ë³€í™˜
        const publicKey = {
          ...optionsFromServer,
          challenge: base64urlToArrayBuffer(optionsFromServer.challenge),
          allowCredentials: optionsFromServer.allowCredentials.map(c => ({
            ...c,
            id: base64urlToArrayBuffer(c.id)
          }))
        };

        const assertion = await navigator.credentials.get({ publicKey });

        // assertionì„ ë‹¤ì‹œ ì„œë²„ë¡œ ë³´ë‚´ì–´ ì„œëª… ê²€ì¦
        const verifyRes = await fetch('/webauthn/assertion-result', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            id: assertion.id,
            rawId: arrayBufferToBase64url(assertion.rawId),
            type: assertion.type,
            response: {
              clientDataJSON: arrayBufferToBase64url(assertion.response.clientDataJSON),
              authenticatorData: arrayBufferToBase64url(assertion.response.authenticatorData),
              signature: arrayBufferToBase64url(assertion.response.signature),
              userHandle: assertion.response.userHandle
                ? arrayBufferToBase64url(assertion.response.userHandle)
                : null
            }
          })
        }).then(r => r.json());

        if (verifyRes.success) {
          setMessage('success', 'ìƒì²´ì¸ì‹ ì¸ì¦ ì„±ê³µ!');
          nextStepEl.style.display = 'block';
        } else {
          setMessage('error', 'ìƒì²´ì¸ì‹ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (verifyRes.message || 'ì›ì¸ ë¶ˆëª…'));
        }
        */

      } catch (err) {
        console.error(err);
        setMessage('error', 'ìƒì²´ì¸ì‹ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
      } finally {
        bioBtn.disabled = false;
      }
    }
  </script>
</body>
</html>

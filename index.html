<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¤– AILee v1 - ì†ê°€ë½ ëª¨ì–‘ ê¸°ë°˜ ë“±ë¡/ì¸ì¦</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:#f5f5f5;padding:10px;
    }
    .container{
      max-width:480px;margin:0 auto;background:#fff;border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:20px;
    }
    .header{text-align:center;margin-bottom:16px;border-bottom:2px solid #0070d2;padding-bottom:10px;}
    .header h1{font-size:20px;color:#0070d2;margin-bottom:4px;}
    .header p{font-size:12px;color:#666;}

    .message{
      padding:8px 10px;margin-bottom:8px;border-radius:6px;font-size:12px;display:none;word-break:break-word;
    }
    .message.show{display:block;}
    .message.info{background:#e7f3ff;border-left:4px solid #0070d2;color:#0070d2;}
    .message.error{background:#fef1f0;border-left:4px solid #c23030;color:#c23030;}
    .message.success{background:#dffcf0;border-left:4px solid #04844b;color:#04844b;}

    .video-container{
      position:relative;width:100%;max-width:480px;margin:0 auto 8px;
      background:#000;border-radius:10px;overflow:hidden;display:none;
    }
    video{width:100%;height:auto;display:block;object-fit:contain;background:#000;}
    .video-label{
      position:absolute;top:8px;left:8px;padding:4px 8px;border-radius:4px;
      background:rgba(0,0,0,0.6);color:#eee;font-size:11px;pointer-events:none;
    }
    .finger-guide{
      position:absolute;top:50%;left:50%;width:45%;height:45%;transform:translate(-50%,-50%);
      border-radius:12px;border:3px dashed rgba(255,255,255,0.9);box-shadow:0 0 0 2px rgba(0,0,0,0.3);
      pointer-events:none;transition:.15s;
    }
    .finger-guide.state-idle{border-color:rgba(255,255,255,0.9);background:transparent;}
    .finger-guide.state-good{border-color:#00c853;box-shadow:0 0 0 2px rgba(0,200,83,0.4);background:rgba(0,200,83,0.08);}
    .finger-guide.state-warn{border-color:#ffb300;box-shadow:0 0 0 2px rgba(255,179,0,0.4);background:rgba(255,179,0,0.08);}
    .finger-guide.state-bad{border-color:#e53935;box-shadow:0 0 0 2px rgba(229,57,53,0.4);background:rgba(229,57,53,0.05);}
    .status-badge{
      position:absolute;bottom:8px;right:8px;padding:4px 8px;border-radius:999px;
      font-size:11px;color:#fff;background:rgba(0,0,0,0.65);pointer-events:none;
    }
    .status-badge.good{background:rgba(0,200,83,0.9);}
    .status-badge.warn{background:rgba(255,179,0,0.9);}
    .status-badge.bad{background:rgba(229,57,53,0.9);}

    .button-group{
      display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;
    }
    button{
      padding:10px 12px;border:none;border-radius:6px;font-size:13px;font-weight:600;
      cursor:pointer;min-height:40px;transition:.15s;
    }
    button:active{transform:scale(.98);}
    .btn-brand{background:#0070d2;color:#fff;}
    .btn-brand:hover{background:#005bb5;}
    .btn-cancel{background:#e0e0e0;color:#333;}
    .btn-cancel:hover{background:#d0d0d0;}
    .btn-disabled{background:#ccc !important;cursor:not-allowed !important;}

    .hint{font-size:11px;color:#777;margin-bottom:8px;}
    .guide{background:#f0f4f8;border-left:4px solid #0070d2;border-radius:6px;padding:10px;margin-top:8px;}
    .guide-title{font-size:13px;font-weight:bold;margin-bottom:4px;color:#333;}
    .guide-list{list-style:none;padding-left:0;}
    .guide-list li{font-size:12px;color:#555;margin-bottom:4px;padding-left:16px;position:relative;}
    .guide-list li::before{content:"â€¢";position:absolute;left:4px;}

    #analyzeCanvas{display:none;}

    /* âœ… ì¸ì¦ ê²°ê³¼ ì˜¤ë²„ë ˆì´ */
    .auth-result{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      padding:14px 20px;
      border-radius:999px;
      background:rgba(0,200,83,0.9);
      color:#fff;
      font-size:16px;
      font-weight:bold;
      display:none;
      align-items:center;
      gap:8px;
      box-shadow:0 4px 16px rgba(0,0,0,0.4);
      z-index:10;
    }
    .auth-result.show{
      display:flex;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤– AILee v1</h1>
      <p>ì†ê°€ë½ ëª¨ì–‘/ë°ê¸° íŒ¨í„´ ê¸°ë°˜ ê°„ë‹¨ ë“±ë¡Â·ì¸ì¦ ë°ëª¨</p>
    </div>

    <div id="infoMessage" class="message info show">
      ì¹´ë©”ë¼ë¥¼ ì¼œê³ , ì†ê°€ë½ì„ ë„¤ëª¨ ì•ˆì— ë§ì¶˜ ë’¤ í’ˆì§ˆì´ ì¢‹ì„ ë•Œ ê¸°ì¤€ì„ ë“±ë¡í•´ë³´ì„¸ìš”.
    </div>
    <div id="errorMessage" class="message error"></div>
    <div id="successMessage" class="message success"></div>

    <div id="videoContainer" class="video-container">
      <video id="video" autoplay playsinline muted></video>
      <div class="video-label">ğŸ“· ì¹´ë©”ë¼ í™œì„± ì¤‘</div>
      <div id="fingerGuide" class="finger-guide state-idle"></div>
      <div id="statusBadge" class="status-badge">ëŒ€ê¸° ì¤‘</div>

      <!-- âœ… ì¸ì¦ ì„±ê³µì‹œ í‘œì‹œë  ì˜¤ë²„ë ˆì´ -->
      <div id="authResult" class="auth-result">
        âœ… ì§€ë¬¸ ì¸ì¦ ì™„ë£Œ
      </div>
    </div>

    <canvas id="analyzeCanvas" width="160" height="120"></canvas>

    <div class="button-group">
      <button id="startBtn" class="btn-brand" onclick="startCamera()">ğŸ“· ì‹œì‘</button>
      <button id="stopBtn" class="btn-cancel btn-disabled" onclick="stopCamera()" disabled>âŒ ì¢…ë£Œ</button>
    </div>
    <div class="button-group">
      <button id="enrollBtn" class="btn-brand btn-disabled" onclick="enrollFinger()" disabled>ğŸ“Œ ê¸°ì¤€ ë“±ë¡</button>
      <button id="verifyBtn" class="btn-brand btn-disabled" onclick="verifyFinger()" disabled>âœ… ì¸ì¦í•˜ê¸°</button>
    </div>

    <div class="hint">
      âš ï¸ ì§„ì§œ ì§€ë¬¸ì„  ì¸ì¦ì´ ì•„ë‹ˆë¼, ì†ê°€ë½ ëª¨ì–‘/ë°ê¸° íŒ¨í„´ ë¹„êµë¼ì„œ ë³´ì•ˆìš©ì´ ì•„ë‹ˆë¼ ë°ëª¨ìš©ì´ë¼ê³  ë³´ë©´ ë¼.
    </div>

    <div class="guide">
      <div class="guide-title">ì‚¬ìš© íë¦„</div>
      <ul class="guide-list">
        <li>[ğŸ“· ì‹œì‘] â†’ ì†ê°€ë½ì„ ì¤‘ì•™ ë„¤ëª¨ì— ë§ì¶”ê¸°</li>
        <li>ë„¤ëª¨ê°€ ì´ˆë¡ìƒ‰ì¼ ë•Œ [ğŸ“Œ ê¸°ì¤€ ë“±ë¡]</li>
        <li>ì†ì„ ë—ë‹¤ ë‹¤ì‹œ ê°™ì€ ì†ê°€ë½ì„ ì˜¬ë¦¬ê³  [âœ… ì¸ì¦í•˜ê¸°]</li>
      </ul>
    </div>
  </div>

  <script>
    let stream=null,video=null,analyzeCanvas=null,analyzeCtx=null,analyzing=false;
    let enrolledTemplate=null,lastQualityStatus='bad';
    const TEMPLATE_SIZE=32,MATCH_THRESHOLD=15;

    const infoMessage=document.getElementById("infoMessage");
    const errorMessage=document.getElementById("errorMessage");
    const successMessage=document.getElementById("successMessage");
    const videoContainer=document.getElementById("videoContainer");
    const fingerGuide=document.getElementById("fingerGuide");
    const statusBadge=document.getElementById("statusBadge");
    const startBtn=document.getElementById("startBtn");
    const stopBtn=document.getElementById("stopBtn");
    const enrollBtn=document.getElementById("enrollBtn");
    const verifyBtn=document.getElementById("verifyBtn");
    const authResult=document.getElementById("authResult"); // âœ… ì˜¤ë²„ë ˆì´ ì—˜ë¦¬ë¨¼íŠ¸

    function setInfo(m){infoMessage.textContent=m;infoMessage.classList.add("show");}
    function clearInfo(){infoMessage.classList.remove("show");}
    function setError(m){errorMessage.textContent=m;errorMessage.classList.add("show");}
    function clearError(){errorMessage.classList.remove("show");}
    function setSuccess(m){successMessage.textContent=m;successMessage.classList.add("show");}
    function clearSuccess(){successMessage.classList.remove("show");}

    function showAuthOverlay(show){
      if(show){
        authResult.classList.add("show");
      }else{
        authResult.classList.remove("show");
      }
    }

    function setButtons(running){
      if(running){
        startBtn.disabled=true;startBtn.classList.add("btn-disabled");
        stopBtn.disabled=false;stopBtn.classList.remove("btn-disabled");
      }else{
        startBtn.disabled=false;startBtn.classList.remove("btn-disabled");
        stopBtn.disabled=true;stopBtn.classList.add("btn-disabled");
      }
      updateEnrollVerifyButtons();
    }

    function updateEnrollVerifyButtons(){
      if(!stream){
        enrollBtn.disabled=true;enrollBtn.classList.add("btn-disabled");
        verifyBtn.disabled=true;verifyBtn.classList.add("btn-disabled");
        return;
      }
      if(lastQualityStatus==='good'){
        enrollBtn.disabled=false;enrollBtn.classList.remove("btn-disabled");
      }else{
        enrollBtn.disabled=true;enrollBtn.classList.add("btn-disabled");
      }
      if(enrolledTemplate && lastQualityStatus==='good'){
        verifyBtn.disabled=false;verifyBtn.classList.remove("btn-disabled");
      }else{
        verifyBtn.disabled=true;verifyBtn.classList.add("btn-disabled");
      }
    }

    async function startCamera(){
      try{
        clearError();clearSuccess();showAuthOverlay(false);
        setInfo("ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...");
        const constraints={
          video:{facingMode:{ideal:"environment"},width:{ideal:1920},height:{ideal:1080}},
          audio:false
        };
        stream=await navigator.mediaDevices.getUserMedia(constraints);
        video=document.getElementById("video");
        analyzeCanvas=document.getElementById("analyzeCanvas");
        analyzeCtx=analyzeCanvas.getContext("2d");
        video.srcObject=stream;
        await video.play();
        videoContainer.style.display="block";
        analyzing=true;
        setButtons(true);
        setInfo("ì†ê°€ë½ì„ ê°€ìš´ë° ë„¤ëª¨ì— ë§ì¶”ë©´ í’ˆì§ˆì„ í‘œì‹œí•©ë‹ˆë‹¤.");
        requestAnimationFrame(analyzeLoop);
      }catch(e){
        setError("ì¹´ë©”ë¼ ì‚¬ìš© ë¶ˆê°€: "+e.message);
        setButtons(false);
      }
    }

    function stopCamera(){
      analyzing=false;
      if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
      if(video){video.srcObject=null;}
      videoContainer.style.display="none";
      fingerGuide.className="finger-guide state-idle";
      statusBadge.className="status-badge";
      statusBadge.textContent="ëŒ€ê¸° ì¤‘";
      lastQualityStatus='bad';
      setButtons(false);
      setInfo("ì¹´ë©”ë¼ ì¢…ë£Œ. ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ [ì‹œì‘]ì„ ëˆ„ë¥´ì„¸ìš”.");
      clearError();clearSuccess();showAuthOverlay(false);
    }

    function isSkinPixel(r,g,b){
      const max=Math.max(r,g,b),min=Math.min(r,g,b),diff=max-min;
      return (r>80&&g>40&&b>20&&r>=g&&r>=b&&diff>15&&!(r>230&&g>230&&b>230));
    }

    function analyzeLoop(){
      if(!analyzing||!video||video.readyState<2){
        if(analyzing)requestAnimationFrame(analyzeLoop);return;
      }
      const w=analyzeCanvas.width,h=analyzeCanvas.height;
      analyzeCtx.drawImage(video,0,0,w,h);
      const frame=analyzeCtx.getImageData(0,0,w,h),data=frame.data;
      const roiX=Math.floor(w*0.275),roiY=Math.floor(h*0.275),
            roiW=Math.floor(w*0.45),roiH=Math.floor(h*0.45);
      let skinCount=0,totalCount=0,minX=roiW,maxX=0,minY=roiH,maxY=0;
      for(let y=roiY;y<roiY+roiH;y++){
        for(let x=roiX;x<roiX+roiW;x++){
          const idx=(y*w+x)*4,r=data[idx],g=data[idx+1],b=data[idx+2];
          totalCount++;
          if(isSkinPixel(r,g,b)){
            skinCount++;
            const lx=x-roiX,ly=y-roiY;
            if(lx<minX)minX=lx;if(lx>maxX)maxX=lx;
            if(ly<minY)minY=ly;if(ly>maxY)maxY=ly;
          }
        }
      }
      const skinRatio=skinCount/totalCount;
      let status="bad",reason="",badgeClass="status-badge bad";
      if(skinRatio<0.05){
        status="bad";
        reason="ì†ê°€ë½ì´ ì˜ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë„¤ëª¨ ì•ˆìœ¼ë¡œ ë§ì¶”ê³  ì¡°ê¸ˆ ë” ê°€ê¹Œì´ ê°€ì ¸ì™€ ì£¼ì„¸ìš”.";
      }else{
        const width=maxX-minX,height=maxY-minY,area=width*height,roiArea=roiW*roiH;
        const areaRatio=area/roiArea;
        const cx=(minX+maxX)/2,cy=(minY+maxY)/2;
        const nx=cx/roiW,ny=cy/roiH;
        const centerTooOff=Math.abs(nx-0.5)>0.2||Math.abs(ny-0.5)>0.2;
        if(centerTooOff){
          status="warn";reason="ì†ê°€ë½ì´ ì¤‘ì•™ì—ì„œ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ë„¤ëª¨ ì¤‘ì•™ìœ¼ë¡œ ë§ì¶° ì£¼ì„¸ìš”.";badgeClass="status-badge warn";
        }else if(areaRatio<0.15){
          status="warn";reason="ì†ê°€ë½ì´ ë„ˆë¬´ ë©€ë¦¬ ìˆìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ìª½ìœ¼ë¡œ ì¡°ê¸ˆ ë” ê°€ê¹Œì´ ê°€ì ¸ì™€ ì£¼ì„¸ìš”.";badgeClass="status-badge warn";
        }else if(areaRatio>0.50){
          status="warn";reason="ì†ê°€ë½ì´ ë„ˆë¬´ ê°€ê¹ìŠµë‹ˆë‹¤. ì•½ê°„ë§Œ ë©€ë¦¬ ë–¼ ì£¼ì„¸ìš”.";badgeClass="status-badge warn";
        }else{
          status="good";reason="ë“±ë¡/ì¸ì¦í•˜ê¸° ì¢‹ì€ ìœ„ì¹˜ì…ë‹ˆë‹¤. ì§€ê¸ˆ [ê¸°ì¤€ ë“±ë¡] ê°€ëŠ¥.";badgeClass="status-badge good";
        }
      }
      lastQualityStatus=status;

      fingerGuide.className="finger-guide state-"+(status==="good"?"good":status==="warn"?"warn":"bad");
      statusBadge.className=badgeClass;
      statusBadge.textContent=
        status==="good"?"í’ˆì§ˆ ì–‘í˜¸ (ë“±ë¡ ê°€ëŠ¥)" :
        status==="warn"?"ì¡°ì • í•„ìš”":"ì†ê°€ë½ ì¸ì‹ ì•½í•¨";

      if(status==="good"){setSuccess(reason);clearError();}
      else{clearSuccess();setError(reason);}

      // í’ˆì§ˆ ì²´í¬ ì¤‘ì—ëŠ” ì¸ì¦ ì˜¤ë²„ë ˆì´ ê°ì¶”ê¸°
      if(status!=="good"){
        showAuthOverlay(false);
      }

      updateEnrollVerifyButtons();
      if(analyzing)requestAnimationFrame(analyzeLoop);
    }

    function captureTemplateFromCurrentFrame(){
      const w=analyzeCanvas.width,h=analyzeCanvas.height;
      analyzeCtx.drawImage(video,0,0,w,h);
      const frame=analyzeCtx.getImageData(0,0,w,h),data=frame.data;
      const roiX=Math.floor(w*0.275),roiY=Math.floor(h*0.275),
            roiW=Math.floor(w*0.45),roiH=Math.floor(h*0.45);
      const tpl=new Float32Array(TEMPLATE_SIZE*TEMPLATE_SIZE);
      const stepX=roiW/TEMPLATE_SIZE,stepY=roiH/TEMPLATE_SIZE;
      let idxTpl=0;
      for(let j=0;j<TEMPLATE_SIZE;j++){
        for(let i=0;i<TEMPLATE_SIZE;i++){
          const x=Math.floor(roiX+i*stepX),y=Math.floor(roiY+j*stepY);
          const idx=(y*w+x)*4,r=data[idx],g=data[idx+1],b=data[idx+2];
          const gray=0.299*r+0.587*g+0.114*b;
          tpl[idxTpl++]=gray;
        }
      }
      return tpl;
    }

    function templateDistance(a,b){
      if(!a||!b||a.length!==b.length)return Infinity;
      let sum=0;for(let i=0;i<a.length;i++)sum+=Math.abs(a[i]-b[i]);
      return sum/a.length;
    }

    function enrollFinger(){
      clearError();clearSuccess();showAuthOverlay(false);
      if(!stream){setError("ì¹´ë©”ë¼ê°€ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € [ì‹œì‘]ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.");return;}
      if(lastQualityStatus!=='good'){
        setError("í’ˆì§ˆì´ ì¢‹ì„ ë•Œë§Œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë„¤ëª¨ê°€ ì´ˆë¡ìƒ‰ì¼ ë•Œ ë‹¤ì‹œ ë“±ë¡í•´ ì£¼ì„¸ìš”.");return;
      }
      enrolledTemplate=captureTemplateFromCurrentFrame();
      setSuccess("í˜„ì¬ ì†ê°€ë½ì„ ê¸°ì¤€ìœ¼ë¡œ ë“±ë¡í–ˆìŠµë‹ˆë‹¤. ê°™ì€ ì†ì¸ì§€ [ì¸ì¦í•˜ê¸°]ë¡œ í™•ì¸í•´ë³´ì„¸ìš”.");
      setInfo("ê°™ì€ ì†ê°€ë½ì„ ë‹¤ì‹œ ë„¤ëª¨ì— ë§ì¶”ê³  [ì¸ì¦í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.");
      updateEnrollVerifyButtons();
    }

    function verifyFinger(){
      clearError();clearSuccess();showAuthOverlay(false);
      if(!enrolledTemplate){setError("ë“±ë¡ëœ ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € [ê¸°ì¤€ ë“±ë¡]ì„ í•´ ì£¼ì„¸ìš”.");return;}
      if(!stream){setError("ì¹´ë©”ë¼ê°€ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤.");return;}
      if(lastQualityStatus!=='good'){
        setError("í’ˆì§ˆì´ ì¢‹ì„ ë•Œë§Œ ì¸ì¦ì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë„¤ëª¨ê°€ ì´ˆë¡ìƒ‰ì¼ ë•Œ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");return;
      }
      setInfo("ë“±ë¡ëœ ê¸°ì¤€ê³¼ í˜„ì¬ ì†ê°€ë½ì„ ë¹„êµ ì¤‘...");
      const cur=captureTemplateFromCurrentFrame();
      const dist=templateDistance(enrolledTemplate,cur);
      if(dist<MATCH_THRESHOLD){
        setSuccess(`ì¸ì¦ ì„±ê³µ: ë“±ë¡ëœ ì†ê°€ë½ê³¼ íŒ¨í„´ì´ ìœ ì‚¬í•©ë‹ˆë‹¤. (ê±°ë¦¬ ${dist.toFixed(1)})`);
        showAuthOverlay(true); // âœ… í™”ë©´ ì¤‘ì•™ì— "ì¸ì¦ ì™„ë£Œ" í‘œì‹œ
      }else{
        setError(`ì¸ì¦ ì‹¤íŒ¨: ë“±ë¡ëœ ì†ê°€ë½ê³¼ ì°¨ì´ê°€ í½ë‹ˆë‹¤. (ê±°ë¦¬ ${dist.toFixed(1)})`);
        showAuthOverlay(false);
      }
    }

    window.addEventListener("unload",()=>{if(stream)stream.getTracks().forEach(t=>t.stop());});
  </script>
</body>
</html>

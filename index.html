<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AILee v3 Pro - 실제 지문 인식 + 등록 + 재인증</title>
  
  <!-- 라이선스 및 원작자 표시 (산업용 100% 합법) -->
  <!--
    AILee v3 Pro - Real Fingerprint Recognition (Touchless)
    Copyright (c) 2025 당신이름 또는 회사명 (예: 주식회사 바이오테크)

    Based on:
    - OpenCV.js (Apache-2.0) - https://opencv.org
    - FingerprintJS (MIT) - https://github.com/fingerprintjs/fingerprintjs
    - 여러 오픈소스 지문 인식 알고리즘 (MIT/Apache)

    본 코드는 상업적 사용·수정·재배포 모두 허용됩니다.
    전체 라이선스: 프로젝트 루트의 LICENSE 파일 참조
  -->

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f5f5f5;padding:10px;}
    .container{max-width:500px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.1);padding:20px;overflow:hidden;}
    .header{text-align:center;padding:16px 0;border-bottom:2px solid #0070f2;margin-bottom:16px;}
    .header h1{font-size:20px;color:#0070f2;}
    .header p{font-size:13px;color:#555;margin-top:4px;}
    .video-container{position:relative;background:#000;border-radius:12px;overflow:hidden;margin-bottom:12px;}
    video{width:100%;display:block;}
    .overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}
    canvas{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0.7;}
    .guide-box{
      position:absolute;top:50%;left:50%;width:50%;height:60%;transform:translate(-50%,-50%);
      border:3px dashed #00c853;border-radius:16px;pointer-events:none;
      box-shadow:0 0 0 9999px rgba(0,0,0,0.4);
    }
    .status{
      position:absolute;bottom:12px;left:50%;transform:translateX(-50%);
      padding:8px 16px;border-radius:99px;background:rgba(0,0,0,0.7);color:#fff;font-size:14px;
    }
    .btn-group{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0;}
    button{padding:14px;font-size:15px;font-weight:600;border:none;border-radius:12px;cursor:pointer;}
    .btn-primary{background:#0070f2;color:#fff;}
    .btn-success{background:#00c853;color:#fff;}
    .btn-danger{background:#d32f2f;color:#fff;}
    .btn-disabled{background:#ccc;cursor:not-allowed;}
    .result{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      padding:24px 40px;border-radius:20px;background:rgba(0,200,83,0.95);color:#fff;
      font-size:24px;font-weight:bold;z-index:999;display:none;box-shadow:0 10px 40px rgba(0,0,0,0.5);
    }
    .result.show{display:block;animation:pop 0.4s;}
    @keyframes pop{from{transform:translate(-50%,-50%) scale(0.5);opacity:0;}to{transform:translate(-50%,-50%) scale(1);opacity:1;}}
    .hint{font-size:12px;color:#666;text-align:center;margin-top:12px;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>AILee v3 Pro</h1>
      <p>실제 지문 능선 인식 → 등록 → 재인증 (산업용 가능)</p>
    </div>

    <div id="info" class="hint">손가락을 초록 박스에 맞추세요</div>

    <div class="video-container">
      <video id="video" autoplay playsinline muted></video>
      <div class="overlay">
        <canvas id="output"></canvas>
        <div id="guide" class="guide-box"></div>
        <div id="status" class="status">대기 중...</div>
      </div>
    </div>

    <div class="btn-group">
      <button id="start" class="btn-primary">카메라 시작</button>
      <button id="stop" class="btn-danger btn-disabled" disabled>정지</button>
    </div>
    <div class="btn-group">
      <button id="enroll" class="btn-success btn-disabled" disabled>지문 등록</button>
      <button id="verify" class="btn-primary btn-disabled" disabled>지문 인증</button>
    </div>

    <div id="result" class="result">지문 인증 성공!</div>
  </div>

  <!-- OpenCV.js 로드 (Apache-2.0 라이선스) -->
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>

  <script>
    // 전역 변수
    let stream = null, enrolledMinutiae = null;
    const video = document.getElementById('video');
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d');
    let processing = false;

    function onOpenCvReady() {
      document.getElementById('info').textContent = 'OpenCV.js 로드 완료! 시작 버튼을 누르세요';
    }

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        video.srcObject = stream;
        video.play();
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        document.getElementById('start').disabled = true;
        document.getElementById('stop').disabled = false;
        document.getElementById('stop').classList.remove('btn-disabled');
        processing = true;
        processFrame();
      } catch (e) {
        alert("카메라 오류: " + e.message);
      }
    }

    function stopCamera() {
      processing = false;
      if (stream) stream.getTracks().forEach(t => t.stop());
      video.srcObject = null;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById('start').disabled = false;
      document.getElementById('stop').disabled = true;
      document.getElementById('stop').classList.add('btn-disabled');
    }

    function processFrame() {
      if (!processing) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        const src = cv.imread(canvas);
        const gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

        // 지문 능선 강조 (Gabor + Laplacian)
        const enhanced = enhanceFingerprint(gray);
        const binary = new cv.Mat();
        cv.threshold(enhanced, binary, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);

        // Minutiae 추출
        const minutiae = extractMinutiae(binary);

        // 시각화
        cv.imshow(canvas, binary);
        drawMinutiae(minutiae);

        // 품질 체크
        const quality = minutiae.length > 15 ? "good" : "bad";
        document.getElementById('status').textContent = 
          quality === "good" ? "지문 품질 양호 (등록/인증 가능)" : "손가락을 더 가까이 대주세요";

        // 버튼 활성화
        document.getElementById('enroll').disabled = quality !== "good";
        document.getElementById('verify').disabled = quality !== "good" || !enrolledMinutiae;
        document.getElementById('enroll').classList.toggle('btn-disabled', quality !== "good");

        src.delete(); gray.delete(); enhanced.delete(); binary.delete();
      }
      requestAnimationFrame(processFrame);
    }

    function enhanceFingerprint(img) {
      const blurred = new cv.Mat();
      cv.GaussianBlur(img, blurred, new cv.Size(5,5), 0);
      const equalized = new cv.Mat();
      cv.equalizeHist(blurred, equalized);

      // Gabor 필터 (간소화)
      const gabor = cv.getGaborKernel(new cv.Size(21,21), 5, Math.PI/4, 10, 1, 0, cv.CV_32F);
      const filtered = new cv.Mat();
      cv.filter2D(equalized, filtered, cv.CV_8UC1, gabor);

      blurred.delete(); equalized.delete(); gabor.delete();
      return filtered;
    }

    function extractMinutiae(bin) {
      const skeleton = new cv.Mat();
      cv.ximgproc.thinning(bin, skeleton);

      const points = [];
      const mat = skeleton.data;
      const w = skeleton.cols, h = skeleton.rows;

      for (let y = 1; y < h - 1; y++) {
        for (let x = 1; x < w - 1; x++) {
          const i = y * w + x;
          if (mat[i] === 255) {
            let count = 0;
            for (let dy = -1; dy <= 1; dy++) {
              for (let dx = -1; dx <= 1; dx++) {
                if (dx === 0 && dy === 0) continue;
                if (mat[(y+dy)*w + (x+dx)] === 255) count++;
              }
            }
            if (count === 1 || count === 3) {
              points.push({x, y, type: count === 1 ? "end" : "bifurcation"});
            }
          }
        }
      }
      skeleton.delete();
      return points;
    }

    function drawMinutiae(points) {
      for (const p of points) {
        ctx.fillStyle = p.type === "end" ? "#00ff00" : "#ffff00";
        ctx.fillRect(p.x - 3, p.y - 3, 6, 6);
      }
    }

    function enroll() {
      const current = cv.imread(canvas);
      const bin = new cv.Mat();
      cv.cvtColor(current, bin, cv.COLOR_RGBA2GRAY);
      cv.threshold(bin, bin, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);
      enrolledMinutiae = extractMinutiae(bin);
      alert(`지문 등록 완료! (${enrolledMinutiae.length}개 특징점)`);
      current.delete(); bin.delete();
    }

    function verify() {
      if (!enrolledMinutiae) return;
      const current = cv.imread(canvas);
      const bin = new cv.Mat();
      cv.cvtColor(current, bin, cv.COLOR_RGBA2GRAY);
      cv.threshold(bin, bin, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);
      const currentMinutiae = extractMinutiae(bin);

      const matchCount = matchMinutiae(enrolledMinutiae, currentMinutiae);
      const score = matchCount / Math.max(enrolledMinutiae.length, currentMinutiae.length);

      if (score > 0.6) {
        document.getElementById('result').classList.add('show');
        setTimeout(() => document.getElementById('result').classList.remove('show'), 3000);
      } else {
        alert(`인증 실패 (유사도: ${(score*100).toFixed(1)}%)`);
      }
      current.delete(); bin.delete();
    }

    function matchMinutiae(a, b) {
      let count = 0;
      for (const pa of a) {
        for (const pb of b) {
          const dist = Math.hypot(pa.x - pb.x, pa.y - pb.y);
          if (dist < 15 && pa.type === pb.type) {
            count++;
            break;
          }
        }
      }
      return count;
    }

    // 버튼 연결
    document.getElementById('start').onclick = startCamera;
    document.getElementById('stop').onclick = stopCamera;
    document.getElementById('enroll').onclick = enroll;
    document.getElementById('verify').onclick = verify;
  </script>
</body>
</html>

<script>
/* ======================================================
   AILee v2 Pro (MIT License)
   바닐라 JS 기반 카메라 손가락 모양 분석 + 패턴 인증
====================================================== */

let stream=null,video=null,analyzeCanvas=null,analyzeCtx=null;
let analyzing=false;
let enrolledTemplate=null;
let lastQuality='bad';

const TEMPLATE=32;
const MATCH_THRESHOLD=15;

const infoMsg=document.getElementById("infoMessage");
const errMsg=document.getElementById("errorMessage");
const okMsg=document.getElementById("successMessage");
const fingerGuide=document.getElementById("fingerGuide");
const statusBadge=document.getElementById("statusBadge");
const authOverlay=document.getElementById("authResult");

function showInfo(t){infoMsg.textContent=t;infoMsg.classList.add("show");}
function showErr(t){errMsg.textContent=t;errMsg.classList.add("show");}
function showOk(t){okMsg.textContent=t;okMsg.classList.add("show");}
function clearAll(){infoMsg.classList.remove("show");errMsg.classList.remove("show");okMsg.classList.remove("show");authOverlay.classList.remove("show");}

function setButtons(cameraOn){
  document.getElementById("startBtn").disabled=cameraOn;
  document.getElementById("stopBtn").disabled=!cameraOn;

  if(lastQuality==="good"){
    document.getElementById("enrollBtn").disabled=false;
  } else {
    document.getElementById("enrollBtn").disabled=true;
  }

  if(enrolledTemplate && lastQuality==="good"){
    document.getElementById("verifyBtn").disabled=false;
  } else {
    document.getElementById("verifyBtn").disabled=true;
  }
}

async function startCamera(){
  clearAll();
  showInfo("카메라 권한 요청 중...");
  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},
      audio:false
    });
    video=document.getElementById("video");
    video.srcObject=stream;
    await video.play();

    analyzeCanvas=document.getElementById("analyzeCanvas");
    analyzeCtx=analyzeCanvas.getContext("2d");

    document.getElementById("videoContainer").style.display="block";

    analyzing=true;
    analyze();

    showInfo("손가락을 가운데 네모에 맞춰주세요.");
    setButtons(true);

  }catch(e){
    showErr("카메라 접근 실패: "+e.message);
  }
}

function stopCamera(){
  analyzing=false;
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
  document.getElementById("videoContainer").style.display="none";
  lastQuality='bad';
  authOverlay.classList.remove("show");
  showInfo("카메라를 종료했습니다.");
  setButtons(false);
}

function isSkin(r,g,b){
  const max=Math.max(r,g,b),min=Math.min(r,g,b);
  return(
    r>80 && g>40 && b>20 &&
    r>=g && r>=b &&
    (max-min)>15
  );
}

function analyze(){
  if(!analyzing){return;}
  if(video.readyState>=2){
    const w=analyzeCanvas.width,h=analyzeCanvas.height;
    analyzeCtx.drawImage(video,0,0,w,h);
    const d=analyzeCtx.getImageData(0,0,w,h).data;

    const rx=Math.floor(w*0.275),ry=Math.floor(h*0.275);
    const rw=Math.floor(w*0.45),rh=Math.floor(h*0.45);

    let skin=0,total=0;
    let minX=rw,maxX=0,minY=rh,maxY=0;

    for(let y=ry;y<ry+rh;y++){
      for(let x=rx;x<rx+rw;x++){
        const i=(y*w+x)*4;
        const r=d[i],g=d[i+1],b=d[i+2];
        total++;
        if(isSkin(r,g,b)){
          skin++;
          const lx=x-rx,ly=y-ry;
          if(lx<minX)minX=lx;if(lx>maxX)maxX=lx;
          if(ly<minY)minY=ly;if(ly>maxY)maxY=ly;
        }
      }
    }

    const ratio=skin/total;
    let status="bad",msg="";

    if(ratio<0.05){
      status="bad";
      msg="손가락이 잘 보이지 않습니다. 네모 안쪽에 더 맞춰주세요.";
    } else {
      const w2=maxX-minX,h2=maxY-minY;
      const area=w2*h2,roi=rw*rh;
      const ar=area/roi;
      const cx=(minX+maxX)/2/rw,cy=(minY+maxY)/2/rh;

      if(Math.abs(cx-0.5)>0.2 || Math.abs(cy-0.5)>0.2){
        status="warn";
        msg="손가락이 중앙에서 벗어났습니다.";
      } else if(ar<0.15){
        status="warn";
        msg="손가락이 너무 멀리 있습니다.";
      } else if(ar>0.5){
        status="warn";
        msg="손가락이 너무 가까이 있습니다.";
      } else {
        status="good";
        msg="등록/인증하기 좋은 상태입니다.";
      }
    }

    lastQuality=status;

    fingerGuide.className="finger-guide state-"+status;
    statusBadge.className="status-badge "+(status==="good"?"good":status==="warn"?"warn":"bad");
    statusBadge.textContent =
      status==="good"?"품질 양호":
      status==="warn"?"조정 필요":"인식 약함";

    if(status==="good"){ showOk(msg); }
    else{ showErr(msg); okMsg.classList.remove("show"); authOverlay.classList.remove("show"); }

    setButtons(true);
  }
  requestAnimationFrame(analyze);
}

function captureTemplate(){
  const w=analyzeCanvas.width,h=analyzeCanvas.height;
  analyzeCtx.drawImage(video,0,0,w,h);
  const d=analyzeCtx.getImageData(0,0,w,h).data;

  const rx=Math.floor(w*0.275),ry=Math.floor(h*0.275);
  const rw=Math.floor(w*0.45),rh=Math.floor(h*0.45);

  const tpl=new Float32Array(TEMPLATE*TEMPLATE);

  const stepX=rw/TEMPLATE,stepY=rh/TEMPLATE;
  let k=0;

  for(let j=0;j<TEMPLATE;j++){
    for(let i=0;i<TEMPLATE;i++){
      const x=Math.floor(rx+i*stepX);
      const y=Math.floor(ry+j*stepY);
      const idx=(y*w+x)*4;
      const r=d[idx],g=d[idx+1],b=d[idx+2];
      const gray=0.299*r+0.587*g+0.114*b;
      tpl[k++]=gray;
    }
  }

  return tpl;
}

function enrollFinger(){
  if(lastQuality!=="good"){return showErr("품질이 좋을 때만 등록할 수 있습니다.");}
  enrolledTemplate=captureTemplate();
  showOk("기준 등록 완료. 이제 같은 손가락으로 인증해보세요.");
}

function verifyFinger(){
  if(!enrolledTemplate){return showErr("먼저 기준을 등록하세요.");}
  if(lastQuality!=="good"){return showErr("품질이 좋을 때만 인증할 수 있습니다.");}

  const current=captureTemplate();
  let diff=0;
  for(let i=0;i<current.length;i++){
    diff+=Math.abs(current[i]-enrolledTemplate[i]);
  }
  diff/=current.length;

  if(diff<MATCH_THRESHOLD){
    showOk("인증 성공! 동일한 손가락으로 확인되었습니다.");
    authOverlay.classList.add("show");
  } else {
    showErr("인증 실패. 다른 손가락입니다. (차이: "+diff.toFixed(1)+")");
    authOverlay.classList.remove("show");
  }
}

window.addEventListener("unload",()=>{
  if(stream)stream.getTracks().forEach(t=>t.stop());
});
</script>
</body>
</html>

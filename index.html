<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¤– AILee v2 - ì§€ë¬¸ì„  ê°•ì¡° í•„í„°</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#f5f5f5;padding:10px;}
    .container{max-width:480px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:20px;}
    .header{text-align:center;margin-bottom:16px;border-bottom:2px solid #0070d2;padding-bottom:10px;}
    .header h1{font-size:20px;color:#0070d2;margin-bottom:4px;}
    .header p{font-size:12px;color:#666;}
    .message{padding:8px 10px;margin-bottom:8px;border-radius:6px;font-size:12px;display:none;}
    .message.show{display:block;}
    .message.info{background:#e7f3ff;border-left:4px solid #0070d2;color:#0070d2;}
    .message.error{background:#fef1f0;border-left:4px solid #c23030;color:#c23030;}
    .video-container{position:relative;width:100%;max-width:480px;margin:0 auto 8px;background:#000;border-radius:10px;overflow:hidden;display:none;}
    video{width:100%;height:auto;display:block;object-fit:contain;background:#000;}
    .video-label{position:absolute;top:8px;left:8px;padding:4px 8px;border-radius:4px;background:rgba(0,0,0,0.6);color:#eee;font-size:11px;}
    .finger-guide{position:absolute;top:50%;left:50%;width:45%;height:45%;transform:translate(-50%,-50%);border-radius:12px;border:2px dashed rgba(255,255,255,0.9);pointer-events:none;}
    .button-group{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
    button{padding:10px 12px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;min-height:40px;}
    .btn-brand{background:#0070d2;color:#fff;}
    .btn-brand:hover{background:#005bb5;}
    .btn-cancel{background:#e0e0e0;color:#333;}
    .btn-cancel:hover{background:#d0d0d0;}
    .btn-disabled{background:#ccc !important;cursor:not-allowed !important;}
    .preview-area{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
    .preview-box{flex:1 1 45%;border:1px solid #ddd;border-radius:8px;padding:6px;text-align:center;font-size:11px;}
    .preview-box canvas{width:100%;height:auto;background:#222;border-radius:4px;}
    #hiddenCanvas{display:none;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤– AILee v2</h1>
      <p>ì†ê°€ë½ ì§€ë¬¸ ì˜ì—­ì„ ìº¡ì²˜í•´ì„œ ì§€ë¬¸ì„ ì„ ê°•ì¡°í•´ ë³´ì—¬ì£¼ëŠ” ë°ëª¨</p>
    </div>

    <div id="infoMessage" class="message info show">
      ì¹´ë©”ë¼ë¥¼ ì¼  ë’¤, ì†ê°€ë½ì„ ë„¤ëª¨ ì•ˆì— ë§ì¶”ê³  [ì§€ë¬¸ ê°•ì¡° ìº¡ì²˜]ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.
    </div>
    <div id="errorMessage" class="message error"></div>

    <div id="videoContainer" class="video-container">
      <video id="video" autoplay playsinline muted></video>
      <div class="video-label">ğŸ“· ì†ê°€ë½ì„ ë„¤ëª¨ ì•ˆì— ë§ì¶”ì„¸ìš”</div>
      <div class="finger-guide"></div>
    </div>

    <canvas id="hiddenCanvas" width="320" height="240"></canvas>

    <div class="button-group">
      <button id="startBtn" class="btn-brand" onclick="startCamera()">ğŸ“· ì‹œì‘</button>
      <button id="stopBtn" class="btn-cancel btn-disabled" onclick="stopCamera()" disabled>âŒ ì¢…ë£Œ</button>
    </div>
    <div class="button-group">
      <button id="captureBtn" class="btn-brand btn-disabled" onclick="captureAndFilter()" disabled>âœ¨ ì§€ë¬¸ ê°•ì¡° ìº¡ì²˜</button>
      <button class="btn-cancel" onclick="clearPreview()">ğŸ§¹ ì§€ìš°ê¸°</button>
    </div>

    <div class="preview-area">
      <div class="preview-box">
        <div>ì›ë³¸ ì†ê°€ë½ ROI</div>
        <canvas id="roiCanvas" width="160" height="160"></canvas>
      </div>
      <div class="preview-box">
        <div>ì§€ë¬¸ì„  ê°•ì¡°(ì—£ì§€ í•„í„°)</div>
        <canvas id="edgeCanvas" width="160" height="160"></canvas>
      </div>
    </div>
  </div>

  <script>
    let stream=null,video=null,hiddenCanvas=null,hiddenCtx=null;
    const infoMessage=document.getElementById("infoMessage");
    const errorMessage=document.getElementById("errorMessage");
    const videoContainer=document.getElementById("videoContainer");
    const startBtn=document.getElementById("startBtn");
    const stopBtn=document.getElementById("stopBtn");
    const captureBtn=document.getElementById("captureBtn");
    const roiCanvas=document.getElementById("roiCanvas");
    const roiCtx=roiCanvas.getContext("2d");
    const edgeCanvas=document.getElementById("edgeCanvas");
    const edgeCtx=edgeCanvas.getContext("2d");

    function setInfo(msg){infoMessage.textContent=msg;infoMessage.classList.add("show");}
    function clearInfo(){infoMessage.classList.remove("show");}
    function setError(msg){errorMessage.textContent=msg;errorMessage.classList.add("show");}
    function clearError(){errorMessage.classList.remove("show");}

    function setButtons(running){
      if(running){
        startBtn.disabled=true;startBtn.classList.add("btn-disabled");
        stopBtn.disabled=false;stopBtn.classList.remove("btn-disabled");
        captureBtn.disabled=false;captureBtn.classList.remove("btn-disabled");
      }else{
        startBtn.disabled=false;startBtn.classList.remove("btn-disabled");
        stopBtn.disabled=true;stopBtn.classList.add("btn-disabled");
        captureBtn.disabled=true;captureBtn.classList.add("btn-disabled");
      }
    }

    async function startCamera(){
      try{
        clearError();
        setInfo("ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...");
        const constraints={
          video:{facingMode:{ideal:"environment"},width:{ideal:1920},height:{ideal:1080}},
          audio:false
        };
        stream=await navigator.mediaDevices.getUserMedia(constraints);
        video=document.getElementById("video");
        hiddenCanvas=document.getElementById("hiddenCanvas");
        hiddenCtx=hiddenCanvas.getContext("2d");
        video.srcObject=stream;
        await video.play();
        videoContainer.style.display="block";
        setButtons(true);
        setInfo("ì†ê°€ë½ì„ ë„¤ëª¨ ì•ˆì— ë§ì¶”ê³  [ì§€ë¬¸ ê°•ì¡° ìº¡ì²˜]ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.");
      }catch(e){
        setError("ì¹´ë©”ë¼ ì‚¬ìš© ë¶ˆê°€: "+e.message);
        setButtons(false);
      }
    }

    function stopCamera(){
      if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
      if(video){video.srcObject=null;}
      videoContainer.style.display="none";
      setButtons(false);
      setInfo("ì¹´ë©”ë¼ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function clearPreview(){
      roiCtx.clearRect(0,0,roiCanvas.width,roiCanvas.height);
      edgeCtx.clearRect(0,0,edgeCanvas.width,edgeCanvas.height);
      clearError();setInfo("ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì› ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìº¡ì²˜í•´ë³´ì„¸ìš”.");
    }

    function captureAndFilter(){
      clearError();
      if(!video||video.readyState<2){setError("ì˜ìƒì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");return;}
      const vw=hiddenCanvas.width,vh=hiddenCanvas.height;
      hiddenCtx.drawImage(video,0,0,vw,vh);
      const frame=hiddenCtx.getImageData(0,0,vw,vh);
      const data=frame.data;
      const roiX=Math.floor(vw*0.275),roiY=Math.floor(vh*0.275),
            roiW=Math.floor(vw*0.45),roiH=Math.floor(vh*0.45);

      // 1) ROIë¥¼ ì •ì‚¬ê°í˜•ìœ¼ë¡œ ì¶•ì†Œí•´ì„œ roiCanvasì— ê·¸ë¦¬ê¸°
      const tmpCanvas=document.createElement("canvas");
      tmpCanvas.width=roiW;tmpCanvas.height=roiH;
      const tmpCtx=tmpCanvas.getContext("2d");
      tmpCtx.putImageData(frame,-roiX,-roiY);
      roiCtx.drawImage(tmpCanvas,0,0,roiW,roiH,0,0,roiCanvas.width,roiCanvas.height);

      // 2) ì—£ì§€ í•„í„° ì ìš©(Sobel)
      const src=roiCtx.getImageData(0,0,roiCanvas.width,roiCanvas.height);
      const dst=edgeCtx.createImageData(src.width,src.height);
      const w=src.width,h=src.height,sData=src.data,dData=dst.data;

      function grayAt(x,y){
        if(x<0||y<0||x>=w||y>=h)return 0;
        const i=(y*w+x)*4;
        return 0.299*sData[i]+0.587*sData[i+1]+0.114*sData[i+2];
      }

      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          const gx=
            -1*grayAt(x-1,y-1)+1*grayAt(x+1,y-1)+
            -2*grayAt(x-1,y  )+2*grayAt(x+1,y  )+
            -1*grayAt(x-1,y+1)+1*grayAt(x+1,y+1);
          const gy=
            -1*grayAt(x-1,y-1)-2*grayAt(x,y-1)-1*grayAt(x+1,y-1)+
             1*grayAt(x-1,y+1)+2*grayAt(x,y+1)+1*grayAt(x+1,y+1);
          let mag=Math.sqrt(gx*gx+gy*gy);
          mag=Math.min(255,mag*1.5);
          const t=100;
          const v=mag>t?255:0;
          const idx=(y*w+x)*4;
          dData[idx]=dData[idx+1]=dData[idx+2]=v;
          dData[idx+3]=255;
        }
      }
      edgeCtx.putImageData(dst,0,0);
      setInfo("ì§€ë¬¸ì„ ì„ ê°•ì¡°í•´ì„œ ì˜¤ë¥¸ìª½ì— í‘œì‹œí–ˆìŠµë‹ˆë‹¤. ë„ˆë¬´ íë¦¬ë©´ ê±°ë¦¬/ê°ë„ë¥¼ ì¡°ì •í•´ì„œ ë‹¤ì‹œ ì°ì–´ë³´ì„¸ìš”.");
    }

    window.addEventListener("unload",()=>{if(stream)stream.getTracks().forEach(t=>t.stop());});
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AILee v4 - ì†ê°€ë½ ìœ¤ê³½ ê¸°ë°˜ ì¸ì¦ ë°ëª¨ (ìŠ¤íŠ¸ë¦­íŠ¸)</title>

  <!--
    AILee v4 - Finger Contour Based Authentication Demo (Strict)
    MIT License (c) 2025 ê¹½í˜¸

    âš  ì‹¤ì œ ì§€ë¬¸ì„ (ë¬´ëŠ¬) ì¸ì¦ì´ ì•„ë‹ˆë¼,
      ì¹´ë©”ë¼ì— ë³´ì´ëŠ” "ì†ê°€ë½ ìœ¤ê³½(í˜•íƒœ + ìœ„ì¹˜ + í¬ê¸°)"ë¥¼ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥/ë¹„êµí•˜ëŠ” ë°ëª¨ì…ë‹ˆë‹¤.
  -->

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:#f5f5f5;
      padding:10px;
    }
    .container{
      max-width:480px;
      margin:0 auto;
      background:#fff;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      padding:20px;
    }
    .header{
      text-align:center;
      margin-bottom:16px;
      border-bottom:2px solid #0070d2;
      padding-bottom:10px;
    }
    .header h1{
      font-size:20px;
      color:#0070d2;
      margin-bottom:4px;
    }
    .header p{
      font-size:12px;
      color:#666;
    }

    .message{
      padding:8px 10px;
      margin-bottom:8px;
      border-radius:6px;
      font-size:12px;
      display:none;
      word-break:break-word;
    }
    .message.show{display:block;}
    .message.info{
      background:#e7f3ff;
      border-left:4px solid #0070d2;
      color:#0070d2;
    }
    .message.warn{
      background:#fff8e1;
      border-left:4px solid #ffb300;
      color:#ff8f00;
    }
    .message.error{
      background:#fef1f0;
      border-left:4px solid #c23030;
      color:#c23030;
    }
    .message.success{
      background:#dffcf0;
      border-left:4px solid #04844b;
      color:#04844b;
    }

    .video-container{
      position:relative;
      width:100%;
      max-width:480px;
      margin:0 auto 8px;
      background:#000;
      border-radius:10px;
      overflow:hidden;
      display:none;
    }
    video{
      width:100%;
      height:auto;
      display:block;
      object-fit:cover;
      background:#000;
    }
    .video-label{
      position:absolute;
      top:8px;
      left:8px;
      padding:4px 8px;
      border-radius:4px;
      background:rgba(0,0,0,0.6);
      color:#eee;
      font-size:11px;
      pointer-events:none;
    }

    .finger-guide{
      position:absolute;
      top:50%;
      left:50%;
      width:45%;
      height:45%;
      transform:translate(-50%,-50%);
      border-radius:12px;
      border:3px dashed rgba(255,255,255,0.9);
      pointer-events:none;
      transition:.15s;
    }
    .finger-guide.state-idle{border-color:rgba(255,255,255,0.9);}
    .finger-guide.state-good{
      border-color:#00c853;
      box-shadow:0 0 0 2px rgba(0,200,83,0.4);
      background:rgba(0,200,83,0.06);
    }
    .finger-guide.state-warn{
      border-color:#ffb300;
      box-shadow:0 0 0 2px rgba(255,179,0,0.4);
      background:rgba(255,179,0,0.08);
    }
    .finger-guide.state-bad{
      border-color:#e53935;
      box-shadow:0 0 0 2px rgba(229,57,53,0.4);
      background:rgba(229,57,53,0.05);
    }

    .status-badge{
      position:absolute;
      bottom:8px;
      right:8px;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      color:#fff;
      background:rgba(0,0,0,0.6);
      pointer-events:none;
    }
    .status-badge.good{background:rgba(0,200,83,0.95);}
    .status-badge.warn{background:rgba(255,179,0,0.95);}
    .status-badge.bad{background:rgba(229,57,53,0.95);}

    .button-group{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-bottom:8px;
    }
    button{
      padding:10px 12px;
      border:none;
      border-radius:6px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      min-height:40px;
      transition:.15s;
    }
    button:active{transform:scale(.97);}
    .btn-brand{background:#0070d2;color:#fff;}
    .btn-brand:hover{background:#005bb5;}
    .btn-cancel{background:#e0e0e0;color:#333;}
    .btn-cancel:hover{background:#d0d0d0;}
    .btn-disabled{background:#ccc !important;cursor:not-allowed !important;}

    #analyzeCanvas{display:none;}

    .auth-result{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      padding:16px 22px;
      border-radius:999px;
      background:rgba(0,200,83,0.92);
      color:white;
      font-size:17px;
      font-weight:bold;
      display:none;
      box-shadow:0 4px 18px rgba(0,0,0,0.4);
      z-index:10;
    }
    .auth-result.show{display:block;}

    .state-panel{
      margin-top:10px;
      padding:8px 10px;
      border-radius:6px;
      background:#f5f7fb;
      font-size:12px;
      color:#444;
    }
    .state-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .state-row:last-child{margin-bottom:0;}
    .state-label{font-weight:bold;}
    .state-value{font-weight:bold;}
    .state-ok{color:#04844b;}
    .state-ng{color:#c23030;}
    .state-wait{color:#666;}

    .hint{
      font-size:11px;
      color:#666;
      margin-top:8px;
      line-height:1.4;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>AILee v4</h1>
      <p>ì†ê°€ë½ ìœ¤ê³½(Contour) ê¸°ë°˜ ì¹´ë©”ë¼ ì¸ì¦ ë°ëª¨ (ìŠ¤íŠ¸ë¦­íŠ¸)</p>
    </div>

    <div id="qualityMessage" class="message info show">
      [ì‹œì‘]ì„ ëˆ„ë¥´ê³  ì†ê°€ë½ì„ ë„¤ëª¨ ì•ˆì— ë§ì¶˜ ë’¤, í’ˆì§ˆì´ ì¢‹ì„ ë•Œ ê¸°ì¤€ì„ ë“±ë¡í•´ ë³´ì„¸ìš”.
    </div>
    <div id="opMessage" class="message"></div>

    <div id="videoContainer" class="video-container">
      <video id="video" autoplay playsinline muted></video>
      <div class="video-label">í›„ë©´ ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸°</div>
      <div id="fingerGuide" class="finger-guide state-idle"></div>
      <div id="statusBadge" class="status-badge">ëŒ€ê¸° ì¤‘</div>
      <div id="authResult" class="auth-result">ì¸ì¦ ì„±ê³µ</div>
    </div>

    <canvas id="analyzeCanvas" width="160" height="120"></canvas>

    <div class="button-group">
      <button id="startBtn"  class="btn-brand"                onclick="startCamera()">ì‹œì‘</button>
      <button id="stopBtn"   class="btn-cancel btn-disabled"  onclick="stopCamera()">ì¢…ë£Œ</button>
    </div>
    <div class="button-group">
      <button id="enrollBtn" class="btn-brand btn-disabled"   onclick="enrollFinger()">ê¸°ì¤€ ë“±ë¡</button>
      <button id="verifyBtn" class="btn-brand btn-disabled"   onclick="verifyFinger()">ì¸ì¦í•˜ê¸°</button>
    </div>

    <div class="state-panel">
      <div class="state-row">
        <span class="state-label">ë“±ë¡ ìƒíƒœ</span>
        <span id="enrollStateValue" class="state-value state-ng">âŒ ë¯¸ë“±ë¡</span>
      </div>
      <div class="state-row">
        <span class="state-label">ìµœê·¼ ì¸ì¦</span>
        <span id="verifyStateValue" class="state-value state-wait">âº ëŒ€ê¸°</span>
      </div>
    </div>

    <div class="hint">
      ğŸ“Œ íŒ<br/>
      - ì†ê°€ë½ì„ ë Œì¦ˆì—ì„œ ì•½ 7~12cm ê±°ë¦¬ë¡œ ìœ ì§€í•˜ë©´ ì´ˆì ì´ ë” ì˜ ë§ìŠµë‹ˆë‹¤.<br/>
      - ì†ê°€ë½ ì¤‘ì‹¬ì´ ë„¤ëª¨ì˜ ê°€ìš´ë°ì— ì˜¤ë„ë¡ ë§ì¶”ê³ , ê°ë„ì™€ ìœ„ì¹˜ë¥¼ í•­ìƒ ë¹„ìŠ·í•˜ê²Œ ìœ ì§€í•˜ë©´ ì¸ì¦ ì„±ê³µë¥ ì´ ì˜¬ë¼ê°‘ë‹ˆë‹¤.<br/>
      - ì´ ë°ëª¨ëŠ” <b>ì§€ë¬¸ ë¬´ëŠ¬</b>ê°€ ì•„ë‹ˆë¼ <b>ì†ê°€ë½ ì „ì²´ ìœ¤ê³½/í˜•íƒœ</b>ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë“±ë¡Â·ì¸ì¦í•©ë‹ˆë‹¤.
    </div>
  </div>

<script>
/* ==============================
   AILee v4 - Finger Contour Auth (Strict)
============================== */

let stream=null;
let video=null;
let analyzeCanvas=null;
let analyzeCtx=null;
let analyzing=false;

let enrolledTemplate=null; // Float32Array (32x32) : 0~1
let lastQuality="bad";

const TEMPLATE_SIZE   = 32;
// â˜… ë³€ê²½: ì„ê³„ê°’ì„ ë” ë¹¡ì„¸ê²Œ (0.18 â†’ 0.10)
const MATCH_THRESHOLD = 0.10;

// DOM
const qualityMessage  = document.getElementById("qualityMessage");
const opMessage       = document.getElementById("opMessage");
const fingerGuide     = document.getElementById("fingerGuide");
const statusBadge     = document.getElementById("statusBadge");
const authResult      = document.getElementById("authResult");
const enrollStateValue= document.getElementById("enrollStateValue");
const verifyStateValue= document.getElementById("verifyStateValue");

function setQuality(status,text){
  qualityMessage.textContent=text;
  qualityMessage.classList.add("show");
  qualityMessage.classList.remove("info","warn","error");
  if(status==="good")      qualityMessage.classList.add("info");
  else if(status==="warn") qualityMessage.classList.add("warn");
  else                     qualityMessage.classList.add("error");
}

function setOp(type,text){
  opMessage.textContent=text;
  opMessage.classList.add("show");
  opMessage.classList.remove("success","error");
  if(type==="success") opMessage.classList.add("success");
  else                 opMessage.classList.add("error");
}

function setButtons(cameraOn){
  const startBtn  = document.getElementById("startBtn");
  const stopBtn   = document.getElementById("stopBtn");
  const enrollBtn = document.getElementById("enrollBtn");
  const verifyBtn = document.getElementById("verifyBtn");

  startBtn.disabled = cameraOn;
  stopBtn.disabled  = !cameraOn;
  stopBtn.classList.toggle("btn-disabled", !cameraOn);

  enrollBtn.disabled = !cameraOn;
  enrollBtn.classList.toggle("btn-disabled", !cameraOn);

  const canVerify = cameraOn && !!enrolledTemplate;
  verifyBtn.disabled = !canVerify;
  verifyBtn.classList.toggle("btn-disabled", !canVerify);
}

// ì¹´ë©”ë¼ ì‹œì‘ (í›„ë©´ + ê³ í•´ìƒë„)
async function startCamera(){
  opMessage.classList.remove("show");
  authResult.classList.remove("show");
  verifyStateValue.textContent = "âº ëŒ€ê¸°";
  verifyStateValue.className = "state-value state-wait";

  const primaryConstraints = {
    video: {
      facingMode: { exact: "environment" },
      width:  { min: 1280, ideal: 1920 },
      height: { min: 720,  ideal: 1080 },
      frameRate: { ideal: 30 }
    },
    audio: false
  };
  const fallbackConstraints = {
    video: {
      facingMode: "environment",
      width:  { min: 640, ideal: 1280 },
      height: { min: 480, ideal: 720 },
      frameRate: { ideal: 24 }
    },
    audio: false
  };

  try{
    setQuality("warn","ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...");

    try{
      stream = await navigator.mediaDevices.getUserMedia(primaryConstraints);
    }catch(e1){
      console.warn("rear exact ì‹¤íŒ¨, fallback:", e1);
      stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
    }

    video = document.getElementById("video");
    video.srcObject = stream;
    await video.play();

    // ì´ˆì /ì¤Œ íŒíŠ¸ (ì§€ì› ê¸°ê¸°ì—ì„œë§Œ)
    try{
      const [track] = stream.getVideoTracks();
      if(track && track.getCapabilities && track.applyConstraints){
        const caps = track.getCapabilities();
        const adv = [];

        if(caps.focusMode && caps.focusMode.includes("continuous")){
          adv.push({ focusMode: "continuous" });
        }
        if(caps.focusMode && caps.focusMode.includes("macro")){
          adv.push({ focusMode: "macro" });
        }
        if(caps.zoom && typeof caps.zoom.max === "number"){
          const minZ = caps.zoom.min || 1;
          const maxZ = caps.zoom.max;
          const midZ = Math.min(maxZ, minZ + (maxZ - minZ)*0.5);
          adv.push({ zoom: midZ });
        }
        if(adv.length>0){
          await track.applyConstraints({ advanced: adv });
          console.log("ê³ ê¸‰ ì¹´ë©”ë¼ ì„¤ì •:", adv);
        }
      }
    }catch(e2){
      console.warn("ê³ ê¸‰ ì„¤ì • ì‹¤íŒ¨(ë¬´ì‹œ ê°€ëŠ¥):", e2);
    }

    analyzeCanvas = document.getElementById("analyzeCanvas");
    analyzeCtx     = analyzeCanvas.getContext("2d");
    document.getElementById("videoContainer").style.display = "block";

    analyzing = true;
    analyzeLoop();
    setQuality("info","ì†ê°€ë½ì„ ë„¤ëª¨ ì¤‘ì•™ì— ë‘ê³ , ê¸¸ì´ 2/3 ì •ë„ê°€ ë„¤ëª¨ ì•ˆì— ë“¤ì–´ì˜¤ë„ë¡ ë§ì¶° ì£¼ì„¸ìš”.");
    setButtons(true);
  }catch(e){
    console.error("ì¹´ë©”ë¼ ì˜¤ë¥˜:", e);
    setQuality("error","ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + e.message);
    setButtons(false);
  }
}

function stopCamera(){
  analyzing = false;
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
  document.getElementById("videoContainer").style.display = "none";
  lastQuality = "bad";
  setQuality("info","ì¹´ë©”ë¼ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.");
  setButtons(false);
}

function isSkin(r,g,b){
  const max = Math.max(r,g,b);
  const min = Math.min(r,g,b);
  return (
    r>80 && g>40 && b>20 &&
    r>=g && r>=b &&
    (max-min)>15
  );
}

// ì‹¤ì‹œê°„ í’ˆì§ˆ ì²´í¬ (ì´ì „ ë²„ì „ ê·¸ëŒ€ë¡œ)
function analyzeLoop(){
  if(!analyzing) return;

  if(video && video.readyState>=2){
    const w = analyzeCanvas.width;
    const h = analyzeCanvas.height;

    analyzeCtx.drawImage(video,0,0,w,h);
    const frame = analyzeCtx.getImageData(0,0,w,h);
    const data  = frame.data;

    const roiX = Math.floor(w*0.275);
    const roiY = Math.floor(h*0.275);
    const roiW = Math.floor(w*0.45);
    const roiH = Math.floor(h*0.45);

    let skinCount = 0;
    let totalCount= 0;
    let borderSkin= 0;
    let centerSkin= 0;

    const borderMargin = 0.08;
    const centerRange  = 0.3;

    for(let y=roiY;y<roiY+roiH;y++){
      for(let x=roiX;x<roiX+roiW;x++){
        const idx=(y*w+x)*4;
        const r=data[idx],g=data[idx+1],b=data[idx+2];
        totalCount++;
        if(!isSkin(r,g,b)) continue;

        skinCount++;
        const nx = (x-roiX)/roiW;
        const ny = (y-roiY)/roiH;
        const isBorder =
          nx<borderMargin || nx>1-borderMargin ||
          ny<borderMargin || ny>1-borderMargin;
        const isCenter =
          nx>0.5-centerRange && nx<0.5+centerRange &&
          ny>0.5-centerRange && ny<0.5+centerRange;

        if(isBorder) borderSkin++;
        if(isCenter) centerSkin++;
      }
    }

    const skinRatio   = skinCount / totalCount;
    const borderRatio = skinCount>0 ? borderSkin/skinCount : 0;
    const centerRatio = skinCount>0 ? centerSkin/skinCount : 0;

    let status="bad", msg="";

    if(skinRatio<0.04){
      status="bad";
      msg="ì†ê°€ë½ì´ ê±°ì˜ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë„¤ëª¨ ì•ˆì— ë” ê°€ê¹ê²Œ ê°€ì ¸ì™€ ì£¼ì„¸ìš”.";
    }else if(centerRatio<0.25){
      status="warn";
      msg="ì†ê°€ë½ì´ ì¤‘ì•™ì—ì„œ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ë„¤ëª¨ ì¤‘ì•™ìœ¼ë¡œ ë§ì¶° ì£¼ì„¸ìš”.";
    }else if(borderRatio>0.65){
      status="warn";
      msg="ì†ê°€ë½ì´ ë„ˆë¬´ ê°€ê¹Œì›Œ ì˜ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ì£¼ ì‚´ì§ ë©€ë¦¬ í•´ ì£¼ì„¸ìš”.";
    }else{
      status="good";
      msg="ê¸°ì¤€ ë“±ë¡/ì¸ì¦í•˜ê¸° ì¢‹ì€ ìœ„ì¹˜ì…ë‹ˆë‹¤.";
    }

    lastQuality = status;

    fingerGuide.className = "finger-guide state-"+status;
    statusBadge.className =
      "status-badge "+(status==="good"?"good":status==="warn"?"warn":"bad");
    statusBadge.textContent =
      status==="good"?"í’ˆì§ˆ ì–‘í˜¸":status==="warn"?"ì¡°ì • í•„ìš”":"ì¸ì‹ ì•½í•¨";

    setQuality(status==="good"?"good":status,msg);
    setButtons(true);
  }

  requestAnimationFrame(analyzeLoop);
}

// ìœ¤ê³½ í…œí”Œë¦¿ ìƒì„±
function captureContourTemplate(){
  if(!video || !analyzeCtx) return null;

  const w = analyzeCanvas.width;
  const h = analyzeCanvas.height;

  analyzeCtx.drawImage(video,0,0,w,h);
  const frame = analyzeCtx.getImageData(0,0,w,h);
  const data  = frame.data;

  const roiX = Math.floor(w*0.275);
  const roiY = Math.floor(h*0.275);
  const roiW = Math.floor(w*0.45);
  const roiH = Math.floor(h*0.45);

  const gridW = TEMPLATE_SIZE;
  const gridH = TEMPLATE_SIZE;

  const cellW = roiW / gridW;
  const cellH = roiH / gridH;

  const tpl = new Float32Array(gridW*gridH);
  let globalSkin = 0;

  for(let gy=0; gy<gridH; gy++){
    for(let gx=0; gx<gridW; gx++){
      const sx0 = Math.floor(roiX + gx*cellW);
      const sy0 = Math.floor(roiY + gy*cellH);
      const sx1 = Math.floor(roiX + (gx+1)*cellW);
      const sy1 = Math.floor(roiY + (gy+1)*cellH);

      let skinCount=0;
      let total=0;

      for(let y=sy0; y<sy1; y++){
        for(let x=sx0; x<sx1; x++){
          const idx=(y*w+x)*4;
          const r=data[idx],g=data[idx+1],b=data[idx+2];
          total++;
          if(isSkin(r,g,b)){
            skinCount++;
          }
        }
      }

      const ratio = total>0 ? skinCount/total : 0;
      tpl[gy*gridW+gx] = ratio;
      globalSkin += skinCount;
    }
  }

  if(globalSkin < (roiW*roiH)*0.03){
    return null;
  }

  return tpl;
}

// â˜… ë³€ê²½: í…œí”Œë¦¿ ê±°ë¦¬ ê³„ì‚°ì„ ë” ì—„ê²©í•˜ê²Œ
// - í‰ê·  ì ˆëŒ€ì°¨(ì „ì²´)
// - ì¤‘ì‹¬ë¶€ ê°€ì¤‘ í‰ê·  ì°¨ì´
// - "ì¼œì§„ ì¹¸" ìœ„ì¹˜ê°€ ì–¼ë§ˆë‚˜ ê²¹ì¹˜ëŠ”ì§€ (Jaccard penalty)
function templateDistance(a,b){
  if(!a || !b || a.length!==b.length) return Infinity;

  const size = TEMPLATE_SIZE;
  const totalCells = size*size;

  let sum = 0;
  let wSum = 0;
  let wTotal = 0;

  let overlap = 0;
  let union   = 0;
  const ON_TH = 0.3;  // ì´ ê°’ ì´ìƒì´ë©´ "ì†ê°€ë½ì´ ìˆë‹¤"ë¡œ íŒë‹¨

  for(let gy=0; gy<size; gy++){
    for(let gx=0; gx<size; gx++){
      const idx = gy*size + gx;
      const va = a[idx];
      const vb = b[idx];

      const diff = Math.abs(va - vb);
      sum += diff;

      // ì¤‘ì‹¬ì— ê°€ê¹Œìš¸ìˆ˜ë¡ weightâ†‘
      const nx = (gx + 0.5)/size - 0.5;
      const ny = (gy + 0.5)/size - 0.5;
      const distCenter = Math.sqrt(nx*nx + ny*ny); // 0~ì•½0.7
      let weight = 1 - distCenter;                 // ì¤‘ì‹¬ 1, ëª¨ì„œë¦¬ ~0.3
      if(weight < 0.2) weight = 0.2;               // ë„ˆë¬´ ì‘ì§€ ì•Šê²Œ
      wSum   += diff * weight;
      wTotal += weight;

      const aOn = va > ON_TH;
      const bOn = vb > ON_TH;
      if(aOn || bOn) union++;
      if(aOn && bOn) overlap++;
    }
  }

  const meanDiff   = sum / totalCells;
  const centerDiff = wSum / wTotal;
  let jaccardPenalty = 1; // ì™„ì „ ë‹¤ë¥´ë©´ 1

  if(union>0){
    const jaccard = overlap / union;   // 1ì´ë©´ ì™„ì „ ë™ì¼í•œ ëª¨ì–‘
    jaccardPenalty = 1 - jaccard;      // 0(ë™ì¼) ~ 1(ì „í˜€ ì•ˆ ê²¹ì¹¨)
  }

  // ìµœì¢… ì ìˆ˜ (0~1, ì‘ì„ìˆ˜ë¡ ë¹„ìŠ·)
  const score = 0.4*meanDiff + 0.4*centerDiff + 0.2*jaccardPenalty;
  return score;
}

function enrollFinger(){
  opMessage.classList.remove("show");
  authResult.classList.remove("show");
  verifyStateValue.textContent = "âº ëŒ€ê¸°";
  verifyStateValue.className = "state-value state-wait";

  const tpl = captureContourTemplate();
  if(!tpl){
    setOp("error","ì†ê°€ë½ ìœ¤ê³½ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤ëª¨ ì•ˆì— ì†ê°€ë½ì„ í¬ê²Œ, ì¤‘ì•™ì— ë‘ê³  ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    return;
  }

  enrolledTemplate = tpl;

  if(lastQuality!=="good"){
    setOp("error","í’ˆì§ˆì€ ì•„ì£¼ ì¢‹ì€ í¸ì€ ì•„ë‹ˆì§€ë§Œ, í˜„ì¬ ì†ê°€ë½ ìœ¤ê³½ì„ ê¸°ì¤€ìœ¼ë¡œ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.");
  }else{
    setOp("success","ê¸°ì¤€ ë“±ë¡ ì™„ë£Œ! ê°™ì€ ì†ê°€ë½ê³¼ ë¹„ìŠ·í•œ ìœ„ì¹˜ë¡œ [ì¸ì¦í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.");
  }

  enrollStateValue.textContent = "âœ… ë“±ë¡ ì™„ë£Œ";
  enrollStateValue.className   = "state-value state-ok";

  setButtons(true);
}

function verifyFinger(){
  opMessage.classList.remove("show");
  authResult.classList.remove("show");

  if(!enrolledTemplate){
    setOp("error","ë¨¼ì € [ê¸°ì¤€ ë“±ë¡]ì„ í•´ ì£¼ì„¸ìš”.");
    return;
  }

  const cur = captureContourTemplate();
  if(!cur){
    setOp("error","í˜„ì¬ í”„ë ˆì„ì—ì„œ ì†ê°€ë½ ìœ¤ê³½ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì†ê°€ë½ì„ ë§ì¶° ì£¼ì„¸ìš”.");
    return;
  }

  const diff = templateDistance(enrolledTemplate, cur);

  if(diff < MATCH_THRESHOLD){
    setOp("success","ì¸ì¦ ì„±ê³µ! (ìœ¤ê³½ ì°¨ì´ê°’: "+diff.toFixed(3)+")");
    authResult.classList.add("show");
    verifyStateValue.textContent = "âœ… ì„±ê³µ";
    verifyStateValue.className   = "state-value state-ok";
  }else{
    setOp("error","ì¸ì¦ ì‹¤íŒ¨. ì†ê°€ë½ ìœ„ì¹˜/ê°ë„ ì°¨ì´ê°€ í¬ê±°ë‚˜ ë‹¤ë¥¸ ì†ê°€ë½ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì°¨ì´ê°’: "+diff.toFixed(3)+")");
    verifyStateValue.textContent = "âŒ ì‹¤íŒ¨";
    verifyStateValue.className   = "state-value state-ng";
  }
}

window.addEventListener("unload",()=>{
  if(stream) stream.getTracks().forEach(t=>t.stop());
});
</script>
</body>
</html>

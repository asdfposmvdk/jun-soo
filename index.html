<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>재택근무 얼굴 출근 인증</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7"></script>
  <style>
    body {font-family: sans-serif; background:#f0f4f8; text-align:center; padding:20px;}
    .box {max-width:420px; margin:0 auto; background:white; border-radius:20px; padding:30px; box-shadow:0 10px 40px rgba(0,0,0,0.1);}
    video {width:100%; border-radius:16px; margin:20px 0;}
    button {padding:16px 32px; margin:10px; font-size:18px; border:none; border-radius:12px; color:white; cursor:pointer;}
    .register {background:#ff6b6b;}
    .checkin  {background:#51cf66;}
    .clear    {background:#868e96;}
    .status {margin:30px 0; font-size:22px; font-weight:bold; min-height:60px;}
    .success {color:#51cf66;}
    .fail    {color:#ff6b6b;}
  </style>
</head>
<body>
  <div class="box">
    <h1>재택근무 얼굴 출근</h1>
    <video id="video" autoplay playsinline muted></video>
    <div class="status" id="status">카메라를 켜고 얼굴을 보여주세요</div>
    
    <button class="register" id="regBtn">얼굴 등록하기</button>
    <button class="checkin"  id="inBtn"  disabled>출근 인증하기</button>
    <button class="clear"    id="clearBtn">등록 삭제</button>
  </div>

  <script>
    const video = document.getElementById('video');
    const status = document.getElementById('status');
    let model, registeredFace = null;

    // 카메라 시작
    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "user"}});
      video.srcObject = stream;
    }

    // 얼굴 모델 로드
    async function loadModel() {
      status.textContent = "AI 모델 로딩 중...";
      model = await blazeface.load();
      status.textContent = "준비 완료! 얼굴을 보여주세요";
      document.getElementById('inBtn').disabled = !localStorage.getItem('faceDesc');
    }

    // 얼굴 특징 벡터 추출
    async function getFaceDescriptor() {
      const predictions = await model.estimateFaces(video, false);
      if (predictions.length === 0) return null;
      const landmarks = predictions[0].landmarks;
      const desc = landmarks.flatMap(p => [p[0], p[1]]);  // 136개의 숫자 배열
      return desc;
    }

    // 거리 계산 (얼굴 유사도)
    function distance(a, b) {
      let sum = 0;
      for (let i = 0; i < a.length; i++) sum += (a[i] - b[i]) ** 2;
      return Math.sqrt(sum);
    }

    // 1. 얼굴 등록
    document.getElementById('regBtn').onclick = async () => {
      status.textContent = "얼굴을 정면으로 보여주세요...";
      await new Promise(r => setTimeout(r, 2000));
      const desc = await getFaceDescriptor();
      if (!desc) {
        status.textContent = "얼굴을 찾지 못했습니다. 다시 시도해주세요";
        return;
      }
      localStorage.setItem('faceDesc', JSON.stringify(desc));
      registeredFace = desc;
      status.innerHTML = `<span class="success">얼굴 등록 완료!</span><br>이제 출근 인증이 가능합니다`;
      document.getElementById('inBtn').disabled = false;
    };

    // 2. 출근 인증 + 현재 위치 주소 표시
    document.getElementById('inBtn').onclick = async () => {
      if (!localStorage.getItem('faceDesc')) return;
      
      status.textContent = "얼굴 확인 중...";
      const current = await getFaceDescriptor();
      if (!current) {
        status.textContent = "얼굴을 찾지 못했습니다";
        return;
      }

      const saved = JSON.parse(localStorage.getItem('faceDesc'));
      const dist = distance(current, saved);

      if (dist < 18) {  // 임계값 (테스트로 18이 적당)
        const now = new Date().toLocaleString('ko-KR');
        const addr = await getCurrentAddress();
        status.innerHTML = `
          <span class="success">출근 인증 완료!</span><br>
          ${now}<br>
          위치: ${addr}
        `;
        // 여기서 서버로 전송 가능
        // fetch('/api/checkin', {method:'POST', body:JSON.stringify({time:now, address:addr})});
      } else {
        status.innerHTML = `<span class="fail">인증 실패 - 등록된 얼굴과 다릅니다</span>`;
      }
    };

    // 현재 위치 주소 가져오기 (카카오맵 API 무료 키 사용)
    async function getCurrentAddress() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) resolve("위치 정보 없음");
        navigator.geolocation.getCurrentPosition(async pos => {
          const {latitude, longitude} = pos.coords;
          try {
            const res = await fetch(`https://dapi.kakao.com/v2/local/geo/coord2address.json?x=${longitude}&y=${latitude}`, {
              headers: {Authorization: 'KakaoAK 2f8e4b8b8b8b8b8b8b8b8b8b8b8b8b8b'}  // ← 여기 본인 키 넣기
            });
            const data = await res.json();
            const addr = data.documents[0]?.address?.address_name || "주소 확인 불가";
            resolve(addr);
          } catch {
            resolve(`${latitude.toFixed(6)}, ${longitude.toFixed(6)}`);
          }
        }, () => resolve("위치 권한 없음"));
      });
    }

    // 등록 삭제
    document.getElementById('clearBtn').onclick = () => {
      localStorage.removeItem('faceDesc');
      registeredFace = null;
      status.textContent = "등록된 얼굴이 삭제되었습니다";
      document.getElementById('inBtn').disabled = true;
    };

    // 시작
    startCamera();
    loadModel();
  </script>
</body>
</html>

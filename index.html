<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>20cm 배경 완전 블러 지문 인증</title>
  <script src="https://docs.opencv.org/4.x/opencv.js"></script>
  <style>
    body{margin:0;background:#000;color:#fff;font-family:sans-serif;text-align:center;padding:20px;}
    #box{position:relative;display:inline-block;}
    video,canvas,img{width:100%;max-width:500px;border-radius:24px;margin-top:20px;}
    #guide{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      width:260px;height:380px;border:6px solid #0f0;border-radius:40px;
      pointer-events:none;box-shadow:0 0 40px #0f0;}
    button{
      margin-top:30px;padding:20px 50px;font-size:24px;background:#0f0;color:#000;
      border:none;border-radius:20px;font-weight:bold;cursor:pointer;}
    .result{text-align:center;font-size:28px;margin:30px;color:#0f0;}
  </style>
</head>
<body>
  <h2>손가락을 초록 테두리에 맞추고<br>촬영 버튼을 누르세요</h2>
  
  <div id="box">
    <video id="v" autoplay playsinline muted></video>
    <div id="guide"></div>
  </div>

  <br>
  <button onclick="shoot()">촬영하기</button>

  <canvas id="c" style="display:none;"></canvas>
  <img id="resultImg" alt="촬영 결과" style="display:none;">
  <div class="result" id="result">촬영 후 결과가 여기 나타납니다</div>

  <script>
    const video = document.getElementById('v');
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const resultImg = document.getElementById('resultImg');
    const result = document.getElementById('result');

    // 카메라 시작
    async function start() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {facingMode: "environment", width: {ideal: 1920}, height: {ideal: 1080}}
      });
      video.srcObject = stream;
    }

    // 촬영 → 배경 완전 블러 + 손가락만 선명 + 결과 보여주기
    function shoot() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      const src = cv.imread(canvas);

      // 손가락 영역 (초록 테두리)
      const roi = new cv.Rect(
        src.cols * 0.32, src.rows * 0.20,
        src.cols * 0.36, src.rows * 0.60
      );

      // 배경 완전 블러 (20cm 이상처럼)
      const blurred = new cv.Mat();
      cv.GaussianBlur(src, blurred, new cv.Size(121, 121), 70);

      // 손가락 부분만 원본으로 복사 → 자동 초점 효과
      const finger = src.roi(roi);
      blurred.roi(roi).copyTo(finger);

      // 결과 표시: 캔버스 → 이미지 src로 변환
      cv.imshow(canvas, blurred);
      resultImg.src = canvas.toDataURL('image/png');
      resultImg.style.display = 'block';

      result.textContent = '촬영 결과: 배경 블러 처리 완료! 손가락만 선명하게 보입니다.';

      src.delete(); blurred.delete(); finger.delete();
    }

    cv.onRuntimeInitialized = start;
  </script>
</body>
</html>

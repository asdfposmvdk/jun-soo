<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>사진 1장으로 지문 추출 (실전용)</title>
  <script src="https://docs.opencv.org/4.x/opencv.js"></script>
  <style>
    body{background:#000;color:#0f0;font-family:monospace;text-align:center;padding:20px;}
    input,button{margin:20px;padding:15px;font-size:20px;}
    canvas,img{max-width:90%;border-radius:20px;margin:20px auto;display:block;border:3px solid #0f0;}
    .step{margin:20px;padding:20px;background:#111;border:2px solid #0f0;border-radius:15px;}
    .point{fill:#0ff;stroke:#000;stroke-width:2;}
  </style>
</head>
<body>
  <h1>손가락 사진 1장으로 지문 추출</h1>
  <p>손가락 사진을 업로드 → 자동으로 지문 특징점 추출</p>

  <input type="file" id="file" accept="image/*">
  <button onclick="process()">지문 추출 시작</button>

  <div class="step">
    <h2>1. 원본 손가락 사진</h2>
    <img id="original" alt="원본">
  </div>

  <div class="step">
    <h2>2. 지문 영역 자동 추출 + 선명도 강화</h2>
    <canvas id="enhanced"></canvas>
  </div>

  <div class="step">
    <h2>3. 지문 능선 + 특징점 (파란점)</h2>
    <canvas id="result"></canvas>
    <h3 id="count">특징점: 0개</h3>
  </div>

  <button onclick="register()" id="reg" disabled style="background:#e74c3c;color:#fff;">지문 등록</button>
  <button onclick="verify()" id="ver" disabled style="background:#27ae60;color:#fff;">지문 인증</button>
  <h3 id="status" style="color:#0f0"></h3>

  <script>
    const fileInput = document.getElementById('file');
    const original = document.getElementById('original');
    const enhanced = document.getElementById('enhanced');
    const result = document.getElementById('result');
    const count = document.getElementById('count');
    const status = document.getElementById('status');
    let currentPoints = [];

    fileInput.onchange = () => {
      const file = fileInput.files[0];
      if (file) {
        original.src = URL.createObjectURL(file);
        original.onload = () => process();
      }
    };

    function process() {
      const img = cv.imread(original);
      const gray = new cv.Mat();
      cv.cvtColor(img, gray, cv.COLOR_RGBA2GRAY);

      // 1. 자동으로 손가락 영역 찾기 (가장 밝고 둥근 부분)
      const blurred = new cv.Mat();
      cv.GaussianBlur(gray, blurred, new cv.Size(21,21), 0);
      const thresh = new cv.Mat();
      cv.threshold(blurred, thresh, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);
      const contours = new cv.MatVector();
      const hierarchy = new cv.Mat();
      cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      let maxArea = 0, best = null;
      for (let i = 0; i < contours.size(); i++) {
        const area = cv.contourArea(contours.get(i));
        if (area > maxArea) { maxArea = area; best = contours.get(i); }
      }

      if (!best) { alert("손가락을 찾지 못했습니다"); return; }

      const mask = cv.Mat.zeros(img.rows, img.cols, cv.CV_8U);
      cv.drawContours(mask, new cv.MatVector(best), -1, new cv.Scalar(255), -1);
      const finger = new cv.Mat();
      img.copyTo(finger, mask);

      // 2. 지문 선명도 극대화 (실전용 필터)
      const clahe = cv.createCLAHE(3, new cv.Size(8,8));
      const enhancedGray = new cv.Mat();
      clahe.apply(gray, enhancedGray);
      const sharp = new cv.Mat();
      cv.GaussianBlur(enhancedGray, sharp, new cv.Size(0,0), 1);
      cv.addWeighted(enhancedGray, 2.5, sharp, -1.5, 0, sharp);

      const bin = new cv.Mat();
      cv.adaptiveThreshold(sharp, bin, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 31, 10);

      // 3. 스켈레톤 + minutiae 추출
      const skel = new cv.Mat();
      cv.ximgproc.thinning(bin, skel);

      const points = [];
      const data = skel.data;
      const w = skel.cols, h = skel.rows;
      for (let y = 10; y < h-10; y++) {
        for (let x = 10; x < w-10; x++) {
          if (data[y*w + x] === 255) {
            let neighbors = 0;
            for (let dy = -1; dy <= 1; dy++)
              for (let dx = -1; dx <= 1; dx++)
                if (dx || dy) neighbors += data[(y+dy)*w + (x+dx)] === 255;
            if (neighbors === 1 || neighbors === 3) points.push({x, y});
          }
        }
      }

      // 결과 표시
      cv.imshow(enhanced, sharp);
      const resultMat = cv.Mat.zeros(skel.rows, skel.cols, cv.CV_8UC3);
      skel.convertTo(resultMat, cv.CV_8UC3, 255);
      points.forEach(p => {
        cv.circle(resultMat, new cv.Point(p.x, p.y), 6, new cv.Scalar(0,255,255), -1);
      });
      cv.imshow(result, resultMat);

      count.textContent = `지문 특징점: ${points.length}개`;
      currentPoints = points;

      if (points.length > 40) {
        document.getElementById('reg').disabled = false;
        document.getElementById('ver').disabled = false;
        status.textContent = "지문 추출 완료! 등록·인증 가능";
      } else {
        status.textContent = "지문이 흐려요. 더 가까이 선명하게 찍어주세요";
      }

      img.delete(); gray.delete(); blurred.delete(); thresh.delete();
      mask.delete(); finger.delete(); enhancedGray.delete(); sharp.delete();
      bin.delete(); skel.delete(); resultMat.delete();
    }

    function register() {
      localStorage.setItem('fingerprint', JSON.stringify(currentPoints));
      status.innerHTML = '<span style="color:#0f0">지문 등록 완료!</span>';
    }

    function verify() {
      const saved = JSON.parse(localStorage.getItem('fingerprint') || '[]');
      if (!saved.length) return alert('등록된 지문 없음');

      let match = 0;
      for (const p of currentPoints)
        for (const q of saved)
          if (Math.hypot(p.x-q.x, p.y-q.y) < 30) { match++; break; }

      const score = (match / Math.max(currentPoints.length, saved.length)) * 100;
      status.innerHTML = score > 60
        ? `<span style="color:#0f0">인증 성공! ${score.toFixed(1)}%</span>`
        : `<span style="color:#f00">인증 실패 ${score.toFixed(1)}%</span>`;
    }

    cv.onRuntimeInitialized = () => {
      status.textContent = "준비 완료! 손가락 사진 업로드하세요";
    };
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AILee v5 - ì† ì „ì²´ ìœ¤ê³½ + ì†ëª¨ì–‘ ê°€ì´ë“œ ì¸ì¦ ë°ëª¨</title>

  <!--
    AILee v5 - Full Hand Contour Authentication Demo with Hand Guide
    MIT License (c) 2025 ê¹½í˜¸

    âš  ì‹¤ì œ ì§€ë¬¸ì„ (ë¬´ëŠ¬) ì¸ì¦ì´ ì•„ë‹ˆë¼,
      ì¹´ë©”ë¼ì— ë³´ì´ëŠ” "ì† ì „ì²´ ìœ¤ê³½(í˜•íƒœ + ìœ„ì¹˜ + í¬ê¸°)"ë¥¼ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥/ë¹„êµí•˜ëŠ” ë°ëª¨ì…ë‹ˆë‹¤.
  -->

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:#f5f5f5;
      padding:10px;
    }
    .container{
      max-width:480px;
      margin:0 auto;
      background:#fff;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      padding:20px;
    }
    .header{
      text-align:center;
      margin-bottom:16px;
      border-bottom:2px solid #0070d2;
      padding-bottom:10px;
    }
    .header h1{
      font-size:20px;
      color:#0070d2;
      margin-bottom:4px;
    }
    .header p{
      font-size:12px;
      color:#666;
    }

    .message{
      padding:8px 10px;
      margin-bottom:8px;
      border-radius:6px;
      font-size:12px;
      display:none;
      word-break:break-word;
    }
    .message.show{display:block;}
    .message.info{
      background:#e7f3ff;
      border-left:4px solid #0070d2;
      color:#0070d2;
    }
    .message.warn{
      background:#fff8e1;
      border-left:4px solid #ffb300;
      color:#ff8f00;
    }
    .message.error{
      background:#fef1f0;
      border-left:4px solid #c23030;
      color:#c23030;
    }
    .message.success{
      background:#dffcf0;
      border-left:4px solid #04844b;
      color:#04844b;
    }

    .video-container{
      position:relative;
      width:100%;
      max-width:480px;
      margin:0 auto 8px;
      background:#000;
      border-radius:10px;
      overflow:hidden;
      display:none;
    }
    video{
      width:100%;
      height:auto;
      display:block;
      object-fit:cover;
      background:#000;
    }
    .video-label{
      position:absolute;
      top:8px;
      left:8px;
      padding:4px 8px;
      border-radius:4px;
      background:rgba(0,0,0,0.6);
      color:#eee;
      font-size:11px;
      pointer-events:none;
    }

    /* ROI ë°•ìŠ¤ (ì† ì „ì²´ ì˜ì—­) */
    .finger-guide{
      position:absolute;
      top:50%;
      left:50%;
      width:70%;   /* ì† ì „ì²´ìš©ìœ¼ë¡œ ë„“ê²Œ */
      height:65%;
      transform:translate(-50%,-50%);
      border-radius:18px;
      border:3px dashed rgba(255,255,255,0.9);
      pointer-events:none;
      transition:.15s;
      box-shadow:0 0 0 2px rgba(0,0,0,0.5);
      overflow:visible;
    }
    .finger-guide.state-idle{border-color:rgba(255,255,255,0.9);}
    .finger-guide.state-good{
      border-color:#00c853;
      box-shadow:0 0 0 2px rgba(0,200,83,0.4);
      background:rgba(0,200,83,0.04);
    }
    .finger-guide.state-warn{
      border-color:#ffb300;
      box-shadow:0 0 0 2px rgba(255,179,0,0.4);
      background:rgba(255,179,0,0.05);
    }
    .finger-guide.state-bad{
      border-color:#e53935;
      box-shadow:0 0 0 2px rgba(229,57,53,0.4);
      background:rgba(229,57,53,0.04);
    }

    /* ì†ëª¨ì–‘ ìœ¤ê³½ì„  SVG ì˜¤ë²„ë ˆì´ */
    .hand-outline{
      position:absolute;
      inset:8%;
      pointer-events:none;
      opacity:0.8;
      filter:drop-shadow(0 0 4px rgba(0,0,0,0.7));
    }
    .hand-outline path{
      fill:rgba(0,0,0,0.1);
      stroke:#ffffff;
      stroke-width:2.2;
      stroke-linejoin:round;
      stroke-linecap:round;
    }
    .hand-outline .guide-dash{
      fill:none;
      stroke-dasharray:6 4;
    }

    .status-badge{
      position:absolute;
      bottom:8px;
      right:8px;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      color:#fff;
      background:rgba(0,0,0,0.6);
      pointer-events:none;
    }
    .status-badge.good{background:rgba(0,200,83,0.95);}
    .status-badge.warn{background:rgba(255,179,0,0.95);}
    .status-badge.bad{background:rgba(229,57,53,0.95);}

    .button-group{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-bottom:8px;
    }
    button{
      padding:10px 12px;
      border:none;
      border-radius:6px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      min-height:40px;
      transition:.15s;
    }
    button:active{transform:scale(.97);}
    .btn-brand{background:#0070d2;color:#fff;}
    .btn-brand:hover{background:#005bb5;}
    .btn-cancel{background:#e0e0e0;color:#333;}
    .btn-cancel:hover{background:#d0d0d0;}
    .btn-disabled{background:#ccc !important;cursor:not-allowed !important;}

    #analyzeCanvas{display:none;}

    .auth-result{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      padding:16px 22px;
      border-radius:999px;
      background:rgba(0,200,83,0.92);
      color:white;
      font-size:17px;
      font-weight:bold;
      display:none;
      box-shadow:0 4px 18px rgba(0,0,0,0.4);
      z-index:10;
    }
    .auth-result.show{display:block;}

    .state-panel{
      margin-top:10px;
      padding:8px 10px;
      border-radius:6px;
      background:#f5f7fb;
      font-size:12px;
      color:#444;
    }
    .state-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .state-row:last-child{margin-bottom:0;}
    .state-label{font-weight:bold;}
    .state-value{font-weight:bold;}
    .state-ok{color:#04844b;}
    .state-ng{color:#c23030;}
    .state-wait{color:#666;}

    .hint{
      font-size:11px;
      color:#666;
      margin-top:8px;
      line-height:1.4;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>AILee v5</h1>
      <p>ì† ì „ì²´ ìœ¤ê³½ + ì†ëª¨ì–‘ ê°€ì´ë“œ ê¸°ë°˜ ì¹´ë©”ë¼ ì¸ì¦ ë°ëª¨</p>
    </div>

    <div id="qualityMessage" class="message info show">
      [ì‹œì‘]ì„ ëˆ„ë¥´ê³  ì†ë°”ë‹¥ì„ í¼ì¹œ í›„, í™”ë©´ì˜ ì†ëª¨ì–‘ ìœ¤ê³½ì„ ì— ìµœëŒ€í•œ ë§ì¶° ì£¼ì„¸ìš”.
    </div>
    <div id="opMessage" class="message"></div>

    <div id="videoContainer" class="video-container">
      <video id="video" autoplay playsinline muted></video>
      <div class="video-label">í›„ë©´ ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸°</div>

      <!-- ì† ì „ì²´ ì˜ì—­ ë°•ìŠ¤ + ì†ëª¨ì–‘ ìœ¤ê³½ì„  -->
      <div id="fingerGuide" class="finger-guide state-idle">
        <svg class="hand-outline" viewBox="0 0 100 140" preserveAspectRatio="xMidYMid meet">
          <!-- ì†ë°”ë‹¥ + ì†ê°€ë½ ì‹¤ë£¨ì—£ (ëŒ€ëµì ì¸ ëª¨ì–‘) -->
          <path d="
            M50 135
            Q30 132 25 115
            L20 80
            Q18 72 22 68
            Q19 64 21 58
            L28 30
            Q29 25 34 26
            Q38 27 38 32
            L37 54
            Q37 56 40 56
            Q43 56 43 54
            L43 20
            Q44 14 50 14
            Q56 14 57 20
            L57 53
            Q57 56 60 56
            Q63 56 63 53
            L63 22
            Q64 16 70 17
            Q76 18 76 25
            L74 57
            Q74 60 77 61
            Q80 62 81 59
            L84 34
            Q85 28 90 29
            Q95 30 94 36
            L91 73
            Q90 84 86 94
            L80 116
            Q75 132 50 135
          " class="guide-dash"/>
        </svg>
      </div>

      <div id="statusBadge" class="status-badge">ëŒ€ê¸° ì¤‘</div>
      <div id="authResult" class="auth-result">ì¸ì¦ ì„±ê³µ</div>
    </div>

    <canvas id="analyzeCanvas" width="160" height="120"></canvas>

    <div class="button-group">
      <button id="startBtn"  class="btn-brand"                onclick="startCamera()">ì‹œì‘</button>
      <button id="stopBtn"   class="btn-cancel btn-disabled"  onclick="stopCamera()">ì¢…ë£Œ</button>
    </div>
    <div class="button-group">
      <button id="enrollBtn" class="btn-brand btn-disabled"   onclick="enrollFinger()">ê¸°ì¤€ ë“±ë¡</button>
      <button id="verifyBtn" class="btn-brand btn-disabled"   onclick="verifyFinger()">ì¸ì¦í•˜ê¸°</button>
    </div>

    <div class="state-panel">
      <div class="state-row">
        <span class="state-label">ë“±ë¡ ìƒíƒœ</span>
        <span id="enrollStateValue" class="state-value state-ng">âŒ ë¯¸ë“±ë¡</span>
      </div>
      <div class="state-row">
        <span class="state-label">ìµœê·¼ ì¸ì¦</span>
        <span id="verifyStateValue" class="state-value state-wait">âº ëŒ€ê¸°</span>
      </div>
    </div>

    <div class="hint">
      ğŸ“Œ íŒ<br/>
      - ì†ë°”ë‹¥ì„ í¼ì³ì„œ <b>ì†ëª¨ì–‘ ìœ¤ê³½ì„ ì— ìµœëŒ€í•œ ê²¹ì¹˜ë„ë¡</b> ë§ì¶° ì£¼ì„¸ìš” (ì—„ì§€ëŠ” ì™¼ìª½/ì˜¤ë¥¸ìª½ ì•„ë¬´ ìª½ì´ë‚˜ í†µì¼).<br/>
      - ë“±ë¡/ì¸ì¦í•  ë•Œ í•­ìƒ ê°™ì€ í¬ì¦ˆÂ·ê±°ë¦¬(ì•½ 20~40cm)ë¥¼ ìœ ì§€í• ìˆ˜ë¡ ì •í™•ë„ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤.<br/>
      - ì´ ë°ëª¨ëŠ” ì§€ë¬¸ ë¬´ëŠ¬ê°€ ì•„ë‹ˆë¼, <b>ì† ì „ì²´ ì‹¤ë£¨ì—£ íŒ¨í„´</b>ì„ ê¸°ì¤€ìœ¼ë¡œ ë“±ë¡Â·ì¸ì¦í•©ë‹ˆë‹¤.
    </div>
  </div>

<script>
/* ==============================
   AILee v5 - Full Hand Contour Auth + Guide (MIT)
============================== */

let stream=null;
let video=null;
let analyzeCanvas=null;
let analyzeCtx=null;
let analyzing=false;

let enrolledTemplate=null; // Float32Array (32x32) : 0~1
let lastQuality="bad";

const TEMPLATE_SIZE   = 32;
const MATCH_THRESHOLD = 0.10; // ì—„ê²©ë„

// ROI ë¹„ìœ¨ (ì† ì „ì²´ìš©)
// í™”ë©´ ê¸°ì¤€ ê°€ìš´ë° 70% x 65%
const ROI_X_RATIO = 0.15;
const ROI_Y_RATIO = 0.175;
const ROI_W_RATIO = 0.70;
const ROI_H_RATIO = 0.65;

// DOM
const qualityMessage  = document.getElementById("qualityMessage");
const opMessage       = document.getElementById("opMessage");
const fingerGuide     = document.getElementById("fingerGuide");
const statusBadge     = document.getElementById("statusBadge");
const authResult      = document.getElementById("authResult");
const enrollStateValue= document.getElementById("enrollStateValue");
const verifyStateValue= document.getElementById("verifyStateValue");

function setQuality(status,text){
  qualityMessage.textContent=text;
  qualityMessage.classList.add("show");
  qualityMessage.classList.remove("info","warn","error");
  if(status==="good")      qualityMessage.classList.add("info");
  else if(status==="warn") qualityMessage.classList.add("warn");
  else                     qualityMessage.classList.add("error");
}

function setOp(type,text){
  opMessage.textContent=text;
  opMessage.classList.add("show");
  opMessage.classList.remove("success","error");
  if(type==="success") opMessage.classList.add("success");
  else                 opMessage.classList.add("error");
}

function setButtons(cameraOn){
  const startBtn  = document.getElementById("startBtn");
  const stopBtn   = document.getElementById("stopBtn");
  const enrollBtn = document.getElementById("enrollBtn");
  const verifyBtn = document.getElementById("verifyBtn");

  startBtn.disabled = cameraOn;
  stopBtn.disabled  = !cameraOn;
  stopBtn.classList.toggle("btn-disabled", !cameraOn);

  enrollBtn.disabled = !cameraOn;
  enrollBtn.classList.toggle("btn-disabled", !cameraOn);

  const canVerify = cameraOn && !!enrolledTemplate;
  verifyBtn.disabled = !canVerify;
  verifyBtn.classList.toggle("btn-disabled", !canVerify);
}

// ì¹´ë©”ë¼ ì‹œì‘
async function startCamera(){
  opMessage.classList.remove("show");
  authResult.classList.remove("show");
  verifyStateValue.textContent = "âº ëŒ€ê¸°";
  verifyStateValue.className = "state-value state-wait";

  const primaryConstraints = {
    video: {
      facingMode: { exact: "environment" },
      width:  { min: 1280, ideal: 1920 },
      height: { min: 720,  ideal: 1080 },
      frameRate: { ideal: 30 }
    },
    audio: false
  };
  const fallbackConstraints = {
    video: {
      facingMode: "environment",
      width:  { min: 640, ideal: 1280 },
      height: { min: 480, ideal: 720 },
      frameRate: { ideal: 24 }
    },
    audio: false
  };

  try{
    setQuality("warn","ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...");

    try{
      stream = await navigator.mediaDevices.getUserMedia(primaryConstraints);
    }catch(e1){
      console.warn("rear exact ì‹¤íŒ¨, fallback:", e1);
      stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
    }

    video = document.getElementById("video");
    video.srcObject = stream;
    await video.play();

    // ì´ˆì /ì¤Œ íŒíŠ¸ (ê°€ëŠ¥í•œ ê²½ìš°ë§Œ)
    try{
      const [track] = stream.getVideoTracks();
      if(track && track.getCapabilities && track.applyConstraints){
        const caps = track.getCapabilities();
        const adv = [];

        if(caps.focusMode && caps.focusMode.includes("continuous")){
          adv.push({ focusMode: "continuous" });
        }
        if(caps.zoom && typeof caps.zoom.max === "number"){
          const minZ = caps.zoom.min || 1;
          const maxZ = caps.zoom.max;
          const midZ = Math.min(maxZ, minZ + (maxZ - minZ)*0.3);
          adv.push({ zoom: midZ });
        }
        if(adv.length>0){
          await track.applyConstraints({ advanced: adv });
          console.log("ê³ ê¸‰ ì¹´ë©”ë¼ ì„¤ì •:", adv);
        }
      }
    }catch(e2){
      console.warn("ê³ ê¸‰ ì„¤ì • ì‹¤íŒ¨(ë¬´ì‹œ ê°€ëŠ¥):", e2);
    }

    analyzeCanvas = document.getElementById("analyzeCanvas");
    analyzeCtx     = analyzeCanvas.getContext("2d");
    document.getElementById("videoContainer").style.display = "block";

    analyzing = true;
    analyzeLoop();
    setQuality("info","ì†ë°”ë‹¥ì„ í¼ì³ì„œ ì†ëª¨ì–‘ ìœ¤ê³½ì„ ì— ìµœëŒ€í•œ ë§ì¶˜ ë’¤, ê¸°ì¤€ ë“±ë¡ì„ í•´ ì£¼ì„¸ìš”.");
    setButtons(true);
  }catch(e){
    console.error("ì¹´ë©”ë¼ ì˜¤ë¥˜:", e);
    setQuality("error","ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + e.message);
    setButtons(false);
  }
}

function stopCamera(){
  analyzing = false;
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
  document.getElementById("videoContainer").style.display = "none";
  lastQuality = "bad";
  setQuality("info","ì¹´ë©”ë¼ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.");
  setButtons(false);
}

function isSkin(r,g,b){
  const max = Math.max(r,g,b);
  const min = Math.min(r,g,b);
  return (
    r>80 && g>40 && b>20 &&
    r>=g && r>=b &&
    (max-min)>15
  );
}

// ì‹¤ì‹œê°„ í’ˆì§ˆ ì²´í¬ (ì† ì „ì²´ìš©)
function analyzeLoop(){
  if(!analyzing) return;

  if(video && video.readyState>=2){
    const w = analyzeCanvas.width;
    const h = analyzeCanvas.height;

    analyzeCtx.drawImage(video,0,0,w,h);
    const frame = analyzeCtx.getImageData(0,0,w,h);
    const data  = frame.data;

    const roiX = Math.floor(w*ROI_X_RATIO);
    const roiY = Math.floor(h*ROI_Y_RATIO);
    const roiW = Math.floor(w*ROI_W_RATIO);
    const roiH = Math.floor(h*ROI_H_RATIO);

    let skinCount = 0;
    let totalCount= 0;
    let borderSkin= 0;
    let centerSkin= 0;

    const borderMargin = 0.06;
    const centerRange  = 0.25;

    for(let y=roiY;y<roiY+roiH;y++){
      for(let x=roiX;x<roiX+roiW;x++){
        const idx=(y*w+x)*4;
        const r=data[idx],g=data[idx+1],b=data[idx+2];
        totalCount++;
        if(!isSkin(r,g,b)) continue;

        skinCount++;
        const nx = (x-roiX)/roiW;
        const ny = (y-roiY)/roiH;
        const isBorder =
          nx<borderMargin || nx>1-borderMargin ||
          ny<borderMargin || ny>1-borderMargin;
        const isCenter =
          nx>0.5-centerRange && nx<0.5+centerRange &&
          ny>0.5-centerRange && ny<0.5+centerRange;

        if(isBorder) borderSkin++;
        if(isCenter) centerSkin++;
      }
    }

    const skinRatio   = skinCount / totalCount;
    const borderRatio = skinCount>0 ? borderSkin/skinCount : 0;
    const centerRatio = skinCount>0 ? centerSkin/skinCount : 0;

    let status="bad", msg="";

    if(skinRatio<0.08){
      status="bad";
      msg="ì†ì´ ê±°ì˜ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ì— ì† ì „ì²´ë¥¼ ë” í¬ê²Œ, ê°€ì´ë“œ ì•ˆìœ¼ë¡œ ê°€ì ¸ì™€ ì£¼ì„¸ìš”.";
    }else if(centerRatio<0.35){
      status="warn";
      msg="ì†ì´ ì¤‘ì•™ì—ì„œ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ì†ëª¨ì–‘ ìœ¤ê³½ì„  ì•ˆìœ¼ë¡œ ë§ì¶° ì£¼ì„¸ìš”.";
    }else if(borderRatio>0.55){
      status="warn";
      msg="ì†ì´ ë„ˆë¬´ ê°€ê¹ê±°ë‚˜ ì˜ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ë’¤ë¡œ ë¬¼ëŸ¬ë‚˜ ì£¼ì„¸ìš”.";
    }else{
      status="good";
      msg="ë“±ë¡/ì¸ì¦í•˜ê¸° ì¢‹ì€ ìœ„ì¹˜ì…ë‹ˆë‹¤. ì´ í¬ì¦ˆë¥¼ ìœ ì§€í•œ ìƒíƒœì—ì„œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.";
    }

    lastQuality = status;

    fingerGuide.className = "finger-guide state-"+status;
    statusBadge.className =
      "status-badge "+(status==="good"?"good":status==="warn"?"warn":"bad");
    statusBadge.textContent =
      status==="good"?"í’ˆì§ˆ ì–‘í˜¸":status==="warn"?"ì¡°ì • í•„ìš”":"ì¸ì‹ ì•½í•¨";

    setQuality(status==="good"?"good":status,msg);
    setButtons(true);
  }

  requestAnimationFrame(analyzeLoop);
}

// ì† ì „ì²´ ìœ¤ê³½ í…œí”Œë¦¿ ìƒì„±
function captureContourTemplate(){
  if(!video || !analyzeCtx) return null;

  const w = analyzeCanvas.width;
  const h = analyzeCanvas.height;

  analyzeCtx.drawImage(video,0,0,w,h);
  const frame = analyzeCtx.getImageData(0,0,w,h);
  const data  = frame.data;

  const roiX = Math.floor(w*ROI_X_RATIO);
  const roiY = Math.floor(h*ROI_Y_RATIO);
  const roiW = Math.floor(w*ROI_W_RATIO);
  const roiH = Math.floor(h*ROI_H_RATIO);

  const gridW = TEMPLATE_SIZE;
  const gridH = TEMPLATE_SIZE;

  const cellW = roiW / gridW;
  const cellH = roiH / gridH;

  const tpl = new Float32Array(gridW*gridH);
  let globalSkin = 0;

  for(let gy=0; gy<gridH; gy++){
    for(let gx=0; gx<gridW; gx++){
      const sx0 = Math.floor(roiX + gx*cellW);
      const sy0 = Math.floor(roiY + gy*cellH);
      const sx1 = Math.floor(roiX + (gx+1)*cellW);
      const sy1 = Math.floor(roiY + (gy+1)*cellH);

      let skinCount=0;
      let total=0;

      for(let y=sy0; y<sy1; y++){
        for(let x=sx0; x<sx1; x++){
          const idx=(y*w+x)*4;
          const r=data[idx],g=data[idx+1],b=data[idx+2];
          total++;
          if(isSkin(r,g,b)){
            skinCount++;
          }
        }
      }

      const ratio = total>0 ? skinCount/total : 0;
      tpl[gy*gridW+gx] = ratio;
      globalSkin += skinCount;
    }
  }

  // ì†ì´ ê±°ì˜ ì—†ëŠ” ê²½ìš°
  if(globalSkin < (roiW*roiH)*0.05){
    return null;
  }

  return tpl;
}

// í…œí”Œë¦¿ ê±°ë¦¬ ê³„ì‚° (mean + center weighted + Jaccard penalty)
function templateDistance(a,b){
  if(!a || !b || a.length!==b.length) return Infinity;

  const size = TEMPLATE_SIZE;
  const totalCells = size*size;

  let sum = 0;
  let wSum = 0;
  let wTotal = 0;

  let overlap = 0;
  let union   = 0;
  const ON_TH = 0.25;

  for(let gy=0; gy<size; gy++){
    for(let gx=0; gx<size; gx++){
      const idx = gy*size + gx;
      const va = a[idx];
      const vb = b[idx];

      const diff = Math.abs(va - vb);
      sum += diff;

      const nx = (gx + 0.5)/size - 0.5;
      const ny = (gy + 0.5)/size - 0.5;
      const distCenter = Math.sqrt(nx*nx + ny*ny);
      let weight = 1 - distCenter;
      if(weight < 0.25) weight = 0.25;
      wSum   += diff * weight;
      wTotal += weight;

      const aOn = va > ON_TH;
      const bOn = vb > ON_TH;
      if(aOn || bOn) union++;
      if(aOn && bOn) overlap++;
    }
  }

  const meanDiff   = sum / totalCells;
  const centerDiff = wSum / wTotal;
  let jaccardPenalty = 1;

  if(union>0){
    const jaccard = overlap / union;
    jaccardPenalty = 1 - jaccard; // 0(ì™„ì „ ë™ì¼) ~ 1(ì „í˜€ ë‹¤ë¦„)
  }

  const score = 0.4*meanDiff + 0.4*centerDiff + 0.2*jaccardPenalty;
  return score;
}

// ê¸°ì¤€ ë“±ë¡
function enrollFinger(){
  opMessage.classList.remove("show");
  authResult.classList.remove("show");
  verifyStateValue.textContent = "âº ëŒ€ê¸°";
  verifyStateValue.className = "state-value state-wait";

  const tpl = captureContourTemplate();
  if(!tpl){
    setOp("error","ì† ìœ¤ê³½ì„ ì œëŒ€ë¡œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì†ëª¨ì–‘ ê°€ì´ë“œ ì•ˆì— ì† ì „ì²´ë¥¼ ë§ì¶˜ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    return;
  }

  enrolledTemplate = tpl;

  if(lastQuality!=="good"){
    setOp("error","í’ˆì§ˆì€ ìµœì ì€ ì•„ë‹ˆì§€ë§Œ, í˜„ì¬ ì†ëª¨ì–‘ì„ ê¸°ì¤€ìœ¼ë¡œ ë“±ë¡í–ˆìŠµë‹ˆë‹¤. í•­ìƒ ë¹„ìŠ·í•œ í¬ì¦ˆë¡œ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.");
  }else{
    setOp("success","ê¸°ì¤€ ë“±ë¡ ì™„ë£Œ! ê°™ì€ ì†ê³¼ í¬ì¦ˆë¡œ [ì¸ì¦í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.");
  }

  enrollStateValue.textContent = "âœ… ë“±ë¡ ì™„ë£Œ";
  enrollStateValue.className   = "state-value state-ok";

  setButtons(true);
}

// ì¸ì¦
function verifyFinger(){
  opMessage.classList.remove("show");
  authResult.classList.remove("show");

  if(!enrolledTemplate){
    setOp("error","ë¨¼ì € [ê¸°ì¤€ ë“±ë¡]ì„ í•´ ì£¼ì„¸ìš”.");
    return;
  }

  const cur = captureContourTemplate();
  if(!cur){
    setOp("error","í˜„ì¬ í”„ë ˆì„ì—ì„œ ì† ìœ¤ê³½ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì†ëª¨ì–‘ ê°€ì´ë“œì— ë‹¤ì‹œ ë§ì¶° ì£¼ì„¸ìš”.");
    return;
  }

  const diff = templateDistance(enrolledTemplate, cur);

  if(diff < MATCH_THRESHOLD){
    setOp("success","ì¸ì¦ ì„±ê³µ! (ìœ¤ê³½ ì°¨ì´ê°’: "+diff.toFixed(3)+")");
    authResult.classList.add("show");
    verifyStateValue.textContent = "âœ… ì„±ê³µ";
    verifyStateValue.className   = "state-value state-ok";
  }else{
    setOp("error","ì¸ì¦ ì‹¤íŒ¨. ì† í¬ì¦ˆ/ìœ„ì¹˜ ì°¨ì´ê°€ í¬ê±°ë‚˜ ë‹¤ë¥¸ ì†ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì°¨ì´ê°’: "+diff.toFixed(3)+")");
    verifyStateValue.textContent = "âŒ ì‹¤íŒ¨";
    verifyStateValue.className   = "state-value state-ng";
  }
}

// í˜ì´ì§€ ë– ë‚  ë•Œ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
window.addEventListener("unload",()=>{
  if(stream) stream.getTracks().forEach(t=>t.stop());
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AILee v4 Final - 지문 등록 + 인증 완료</title>
  
  <!-- 라이선스: 산업용 100% 합법 -->
  <!--
    AILee v4 Final - Real Fingerprint Registration & Verification
    Copyright (c) 2025 당신이름 또는 회사명
    Based on OpenCV.js (Apache-2.0) + MIT licensed open source
    상업적 사용·수정·재배포 모두 허용. 동의 필요 없음.
  -->

  <style>
    body{font-family:sans-serif;background:#f0f0f0;padding:20px;text-align:center;}
    .container{max-width:500px;margin:0 auto;background:white;border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.1);}
    video{width:100%;border-radius:16px;margin:16px 0;}
    canvas{display:none;}
    button{padding:16px 24px;margin:8px;font-size:18px;border:none;border-radius:12px;color:white;cursor:pointer;}
    .btn-start{background:#0070f2;}
    .btn-enroll{background:#00c853;}
    .btn-verify{background:#ff9800;}
    .btn-clear{background:#d32f2f;}
    .btn-disabled{background:#999;cursor:not-allowed;}
    .status{margin:16px 0;font-size:18px;font-weight:bold;}
    .result{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      padding:30px 50px;border-radius:20px;font-size:28px;color:white;z-index:999;
      display:none;box-shadow:0 20px 50px rgba(0,0,0,0.5);
    }
    .success{background:#00c853;animation:pop 0.5s;}
    .fail{background:#d32f2f;}
    @keyframes pop{from{transform:translate(-50%,-50%) scale(0.5);opacity:0;}to{transform:translate(-50%,-50%) scale(1);opacity:1;}}
  </style>
</head>
<body>
  <div class="container">
    <h1>AILee v4 Final</h1>
    <p>손가락을 카메라에 가까이 대고 등록 → 인증해보세요</p>
    
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
    
    <div class="status" id="status">시작 버튼을 누르세요</div>
    
    <button id="start" class="btn-start">카메라 시작</button>
    <button id="enroll" class="btn-enroll btn-disabled" disabled>지문 등록</button>
    <button id="verify" class="btn-verify btn-disabled" disabled>지문 인증</button>
    <button id="clear" class="btn-clear">등록 지우기</button>
  </div>

  <div id="result" class="result success">지문 인증 성공!</div>
  <div id="resultFail" class="result fail">인증 실패</div>

  <!-- OpenCV.js (Apache-2.0) -->
  <script src="https://docs.opencv.org/4.x/opencv.js" async onload="onOpenCvReady()"></script>

  <script>
    let stream, enrolled = null;
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    function onOpenCvReady() {
      document.getElementById('status').textContent = "준비 완료! 시작 버튼을 눌러주세요";
    }

    // 1. 카메라 시작
    document.getElementById('start').onclick = async () => {
      stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}});
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        document.getElementById('enroll').disabled = false;
        document.getElementById('enroll').classList.remove('btn-disabled');
        document.getElementById('verify').disabled = !localStorage.getItem('fingerprint');
        document.getElementById('status').textContent = "손가락을 가까이 대주세요";
        processFrame();
      };
    };

    // 2. 실시간 처리
    function processFrame() {
      if (!video.srcObject) return;
      ctx.drawImage(video, 0, 0);
      const src = cv.imread(canvas);
      const gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      
      // 지문 강조 + 이진화
      const enhanced = enhance(gray);
      const binary = new cv.Mat();
      cv.threshold(enhanced, binary, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);
      
      // Minutiae 추출
      const points = extractMinutiae(binary);
      document.getElementById('status').textContent = `특징점 ${points.length}개 검출됨`;
      
      if (points.length > 20) {
        document.getElementById('enroll').disabled = false;
        document.getElementById('enroll').classList.remove('btn-disabled');
        document.getElementById('verify').disabled = false;
        document.getElementById('verify').classList.remove('btn-disabled');
      }
      
      src.delete(); gray.delete(); enhanced.delete(); binary.delete();
      requestAnimationFrame(processFrame);
    }

    function enhance(img) {
      const blurred = new cv.Mat();
      cv.GaussianBlur(img, blurred, new cv.Size(9,9), 0);
      const equalized = new cv.Mat();
      cv.equalizeHist(blurred, equalized);
      blurred.delete();
      return equalized;
    }

    function extractMinutiae(bin) {
      const skeleton = new cv.Mat();
      cv.ximgproc.thinning(bin, skeleton);
      const points = [];
      const data = skeleton.data;
      const w = skeleton.cols, h = skeleton.rows;
      
      for (let y = 1; y < h-1; y++) {
        for (let x = 1; x < w-1; x++) {
          const i = y * w + x;
          if (data[i] === 255) {
            let neighbors = 0;
            const dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
            dirs.forEach(([dy,dx]) => {
              if (data[(y+dy)*w + (x+dx)] === 255) neighbors++;
            });
            if (neighbors === 1 || neighbors === 3) {
              points.push({x, y, type: neighbors === 1 ? "end" : "bif"});
            }
          }
        }
      }
      skeleton.delete();
      return points;
    }

    // 3. 지문 등록
    document.getElementById('enroll').onclick = () => {
      ctx.drawImage(video, 0, 0);
      const src = cv.imread(canvas);
      const gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      const enhanced = enhance(gray);
      const binary = new cv.Mat();
      cv.threshold(enhanced, binary, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);
      enrolled = extractMinutiae(binary);
      
      localStorage.setItem('fingerprint', JSON.stringify(enrolled));
      alert(`지문 등록 완료! (${enrolled.length}개 특징점 저장됨)`);
      
      src.delete(); gray.delete(); enhanced.delete(); binary.delete();
    };

    // 4. 지문 인증
    document.getElementById('verify').onclick = () => {
      if (!localStorage.getItem('fingerprint')) {
        alert("등록된 지문이 없습니다");
        return;
      }
      
      ctx.drawImage(video, 0, 0);
      const src = cv.imread(canvas);
      const gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      const enhanced = enhance(gray);
      const binary = new cv.Mat();
      cv.threshold(enhanced, binary, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);
      const current = extractMinutiae(binary);
      
      const saved = JSON.parse(localStorage.getItem('fingerprint'));
      const match = compare(current, saved);
      
      if (match > 0.55) {
        document.getElementById('result').style.display = 'block';
        setTimeout(() => document.getElementById('result').style.display = 'none', 3000);
      } else {
        document.getElementById('resultFail').style.display = 'block';
        setTimeout(() => document.getElementById('resultFail').style.display = 'none', 3000);
      }
      
      src.delete(); gray.delete(); enhanced.delete(); binary.delete();
    };

    function compare(a, b) {
      let matches = 0;
      for (const pa of a) {
        for (const pb of b) {
          const dist = Math.hypot(pa.x - pb.x, pa.y - pb.y);
          if (dist < 20 && pa.type === pb.type) {
            matches++;
            break;
          }
        }
      }
      return matches / Math.max(a.length, b.length);
    }

    // 등록 지우기
    document.getElementById('clear').onclick = () => {
      localStorage.removeItem('fingerprint');
      alert("등록된 지문이 삭제되었습니다");
    };
  </script>
</body>
</html>
